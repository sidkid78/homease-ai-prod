<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Agent Response - orchestrator&lowbar;workers</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="agent-response---orchestrator_workers">Agent Response - orchestrator_workers</h1>
<p><strong>Session ID</strong>: 1d8ed662-c6e2-46f3-a121-2d3cd50b49ae
<strong>Processing Time</strong>: 344.74 seconds</p>
<h2 id="final-response">Final Response</h2>
<p>Here is a solid, detailed technical architecture plan for the HOMEase AI platform, synthesized from the provided documentation and designed for execution by a development team.</p>
<h3 id="executive-summary"><strong>Executive Summary</strong></h3>
<p>This document presents the comprehensive technical architecture for the HOMEase AI platform, a lead generation service connecting homeowners with aging-in-place (AIP) contractors. The architecture is designed to be scalable, secure, and cost-efficient, directly supporting the business's strategic pivot to a pure-play lead generation model.</p>
<p>The platform is built exclusively on the Google Cloud Platform (GCP) ecosystem, leveraging a serverless, event-driven model to achieve rapid development cycles and operational efficiency. The core components include a Next.js 15 frontend hosted on <strong>Google Cloud Run</strong> (explicitly excluding Vercel), a suite of backend services using <strong>Google Cloud Functions</strong>, and a unified data layer with <strong>Firebase Firestore, Authentication, and Storage</strong>.</p>
<p>Key architectural features include:</p>
<ul>
<li><strong>Asynchronous Workflows:</strong> Core processes like AR assessment analysis and contractor matching are handled asynchronously using Google Cloud Pub/Sub, ensuring a responsive user experience.</li>
<li><strong>Role-Based Access Control (RBAC):</strong> A robust security model using Firebase Custom Claims and NextAuth.js enforces strict permissions for homeowners, contractors, and administrators across the entire application stack.</li>
<li><strong>Integrated Payments &amp; Vetting:</strong> A seamless contractor onboarding and payment system is built using Stripe Connect and Stripe Checkout, automated via secure webhooks.</li>
<li><strong>Automated CI/CD:</strong> A complete DevOps pipeline using GitHub Actions and Google Cloud's Workload Identity Federation enables secure, automated deployments to isolated development, staging, and production environments.</li>
</ul>
<p>This plan provides a blueprint for building a high-performance, secure, and scalable platform poised to capture a significant share of the growing AIP market.</p>
<hr>
<h3 id="1-high-level-system-architecture"><strong>1. High-Level System Architecture</strong></h3>
<p>HOMEase AI employs a serverless, event-driven architecture hosted entirely on GCP. This model is chosen for its inherent scalability, pay-per-use cost structure, and reduced operational overhead.</p>
<h4 id="11-core-technology-stack"><strong>1.1. Core Technology Stack</strong></h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication with NextAuth.js v5</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd Gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (Analysis), <a href="http://Fal.ai">Fal.ai</a> (Visualization)</li>
<li><strong>Payments:</strong> Stripe (Connect &amp; Checkout)</li>
<li><strong>CI/CD:</strong> GitHub Actions &amp; Google Cloud Build</li>
</ul>
<h4 id="12-architecture-diagram"><strong>1.2. Architecture Diagram</strong></h4>
<p>The diagram below illustrates the interaction between system components. The Next.js application on Cloud Run serves as the primary interface, orchestrating calls to backend services and responding to real-time database updates.</p>
<pre><code class="language-mermaid">graph TD
    subgraph &quot;User Devices&quot;
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph &quot;Google Cloud Platform&quot;
        subgraph &quot;Application &amp; API Tier&quot;
            C(Next.js App on Cloud Run)
        end

        subgraph &quot;Asynchronous Processing Tier&quot;
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
            P[Cloud Function: stripeWebhookHandler]
        end

        subgraph &quot;Data &amp; Persistence Tier&quot;
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph &quot;External Services&quot;
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions &amp; Synchronous Flow
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C
    C -- Authenticates User --&gt; H
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J
    C -- Initiates Onboarding/Payment --&gt; L

    %% Asynchronous Workflows
    C -- Publishes Message --&gt; D
    C -- Publishes Message --&gt; E
    D -- Triggers --&gt; F
    E -- Triggers --&gt; G
    L -- Sends Webhooks --&gt; P

    %% Backend Processing
    F -- Reads/Writes Data --&gt; I
    G -- Reads Files --&gt; J
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Results --&gt; I
    P -- Writes Payment/Vetting Status --&gt; I

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</code></pre>
<hr>
<h3 id="2-data-modeling--persistence"><strong>2. Data Modeling &amp; Persistence</strong></h3>
<p>The data layer is built on Firestore, a scalable NoSQL database. The schema is designed with denormalization to optimize for the application's primary read patterns.</p>
<h4 id="21-firestore-collection-schema"><strong>2.1. Firestore Collection Schema</strong></h4>
<ul>
<li><strong><code>users</code></strong>: Stores profiles for all roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>), identified by their Firebase Auth UID. Contractor profiles include a <code>contractorProfile</code> map containing vetting status, specialties, service area ZIPs, and their <code>stripeAccountId</code>.</li>
<li><strong><code>leads</code></strong>: Represents a homeowner's request for work. It includes denormalized homeowner info, the <code>arAssessmentId</code>, status (<code>new</code>, <code>matching</code>, <code>matched</code>, <code>sold</code>), price, and arrays for <code>matchedContractorIds</code> and <code>purchasedBy</code> contractor IDs.</li>
<li><strong><code>ar-assessments</code></strong>: Contains the results of an AR scan, including <code>status</code> (<code>processing</code>, <code>complete</code>), links to raw data in Cloud Storage, and the final <code>results</code> from the Gemini AI analysis.</li>
<li><strong><code>projects</code></strong>: Tracks a confirmed job between a homeowner and contractor, linking the lead, participants, and final scope.</li>
<li><strong><code>chats</code></strong>: Manages conversation threads, with a <code>messages</code> subcollection for individual messages.</li>
<li><strong><code>reviews</code></strong>: Stores ratings and comments for completed projects. An <code>onWrite</code> Cloud Function aggregates these reviews to update a contractor's average rating in their <code>users</code> document.</li>
<li><strong><code>transactions</code></strong>: Logs all payment events from Stripe for accounting and auditing, using the Stripe session or payment intent ID as the document ID for idempotency.</li>
</ul>
<h4 id="22-firestore-security-rules"><strong>2.2. Firestore Security Rules</strong></h4>
<p>Security rules are the primary mechanism for enforcing data access control at the database level. They are non-negotiable and protect data even if the application backend is compromised.</p>
<ul>
<li><strong>Users</strong>: Users can read and update their own profiles. Public contractor information is readable by any authenticated user. Admins have full access.</li>
<li><strong>Leads</strong>: A lead can be read only by its owner, a matched contractor, or an admin. Only homeowners can create leads.</li>
<li><strong>AR Assessments</strong>: Can only be accessed by the user who created it or an admin.</li>
<li><strong>Chats &amp; Messages</strong>: Can only be accessed by the participants of the chat.</li>
<li><strong>Reviews</strong>: Are public to read but can only be created by the homeowner of a completed project. Reviews are immutable by users.</li>
</ul>
<hr>
<h3 id="3-authentication--role-based-access-control-rbac"><strong>3. Authentication &amp; Role-Based Access Control (RBAC)</strong></h3>
<p>A multi-layered RBAC strategy ensures that users can only perform actions and access data appropriate for their role.</p>
<ol>
<li><strong>Authentication Provider</strong>: <strong>NextAuth.js v5</strong> is used with the <strong>Firebase Auth provider</strong>. Firebase securely manages user credentials, social logins, and issues ID tokens.</li>
<li><strong>Authoritative Role Source</strong>: <strong>Firebase Custom Claims</strong> are the single source of truth for user roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>).</li>
<li><strong>Role Assignment</strong>: Upon user signup, a Cloud Function (<code>onUserCreate</code>) is triggered. It reads the user's intended role (set during the signup flow) from a temporary Firestore document and uses the Firebase Admin SDK to write the role as a custom claim to the user's auth token. This process is entirely server-side and secure from client-side manipulation.</li>
<li><strong>Session Propagation</strong>: NextAuth.js is configured to decode the user's ID token upon login, extract the custom <code>role</code> claim, and inject it into the session object.</li>
<li><strong>Permission Enforcement</strong>:
<ul>
<li><strong>Next.js (Server Components &amp; API Routes)</strong>: Server-side code checks <code>session.user.role</code> to authorize access to pages and API endpoints.</li>
<li><strong>Next.js (Client Components)</strong>: The UI is conditionally rendered based on the <code>role</code> available in the <code>useSession()</code> hook.</li>
<li><strong>Cloud Functions</strong>: Callable Functions automatically receive a verified auth <code>context</code> containing the decoded token and its claims, allowing for role checks at the start of any backend process.</li>
<li><strong>Firestore Rules</strong>: Rules use helper functions to read the user's role from their request token (<code>request.auth.token.role</code>) to enforce database-level permissions.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-core-workflows"><strong>4. Core Workflows</strong></h3>
<p>The platform's primary functions are designed as decoupled, asynchronous workflows to ensure scalability and a responsive user experience.</p>
<h4 id="41-ar-assessment--ai-processing"><strong>4.1. AR Assessment &amp; AI Processing</strong></h4>
<ol>
<li><strong>Upload</strong>: The homeowner's app uploads raw AR data (images, measurements) directly to a secure path in <strong>Google Cloud Storage</strong>.</li>
<li><strong>Trigger</strong>: Upon successful upload, the app calls a lightweight Next.js API route (<code>/api/ar-assessments/process</code>), which updates the assessment's status in Firestore to <code>'processing'</code> and publishes a message to the <code>ar-assessment-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Process</strong>: An event-driven <strong>Cloud Function (<code>arProcessing</code>)</strong> is triggered by the Pub/Sub message. It downloads the data from Storage, sends it to the <strong>Google Gemini API</strong> for hazard detection and recommendations, and calls <strong><a href="http://Fal.ai">Fal.ai</a></strong> to generate &quot;after&quot; visualizations.</li>
<li><strong>Update</strong>: The function writes the complete analysis back to the assessment's Firestore document and updates its status to <code>'complete'</code>.</li>
<li><strong>Notify</strong>: The homeowner's app, listening for real-time changes to the document, automatically updates the UI to display the full report.</li>
</ol>
<h4 id="42-lead-generation--contractor-matching"><strong>4.2. Lead Generation &amp; Contractor Matching</strong></h4>
<ol>
<li><strong>Submission</strong>: A homeowner submits a lead request via a Next.js form. The API route (<code>/api/leads/create</code>) validates the data, creates a new lead document in Firestore with a status of <code>'new'</code>, and immediately publishes a message with the <code>leadId</code> to the <code>lead-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Matching</strong>: The <code>leadMatching</code> <strong>Cloud Function</strong> is triggered. It updates the lead status to <code>'matching'</code>, then queries the <code>users</code> collection for approved contractors whose <code>serviceAreaZips</code> and <code>specialties</code> match the lead's requirements.</li>
<li><strong>Ranking &amp; Update</strong>: The function ranks the potential matches (e.g., by average rating, review count) and updates the lead document in Firestore with an array of the top <code>matchedContractorIds</code> and a new status of <code>'matched'</code>.</li>
<li><strong>Notify</strong>: Both the homeowner and the matched contractors receive real-time updates in their dashboards via Firestore listeners, informing them of the match.</li>
</ol>
<h4 id="43-contractor-onboarding--payments"><strong>4.3. Contractor Onboarding &amp; Payments</strong></h4>
<ol>
<li><strong>Onboarding</strong>: The system uses <strong>Stripe Connect Express</strong>. A contractor initiates onboarding from their dashboard, triggering a server-side process that creates a Stripe Express account and generates a one-time onboarding link. The contractor is redirected to Stripe's co-branded UI to submit their business and bank details.</li>
<li><strong>Verification</strong>: Stripe handles the identity verification asynchronously. When the account is verified, Stripe sends an <code>account.updated</code> event to a secure webhook endpoint.</li>
<li><strong>Pay-Per-Lead Purchase</strong>: An approved contractor can purchase a lead. This action calls a Next.js API route that creates a <strong>Stripe Checkout Session</strong>, embedding the <code>leadId</code> and <code>contractorId</code> in the session's <code>metadata</code>. The contractor is redirected to Stripe's secure payment page.</li>
<li><strong>Webhook Handling</strong>: A single, secure <strong>Cloud Function (<code>stripeWebhookHandler</code>)</strong> with an HTTP trigger acts as the endpoint for all Stripe webhooks. It verifies the Stripe signature of every incoming request.
<ul>
<li>On an <code>account.updated</code> event, it updates the contractor's <code>vettingStatus</code> in Firestore to <code>'approved'</code>.</li>
<li>On a <code>checkout.session.completed</code> event, it reads the <code>metadata</code> to identify the lead and contractor, then updates the lead document in Firestore to grant the contractor access.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-frontend-architecture-nextjs-15-on-cloud-run"><strong>5. Frontend Architecture (Next.js 15 on Cloud Run)</strong></h3>
<p>The frontend is a monolithic Next.js 15 application using the App Router, prioritizing performance and maintainability with a &quot;Server-First&quot; approach.</p>
<ul>
<li><strong>Component Strategy</strong>: <strong>React Server Components (RSCs)</strong> are used by default to fetch data and render UI on the server, minimizing client-side JavaScript. <strong>Client Components (<code>'use client'</code>)</strong> are used only when necessary for interactivity, such as forms, AR uploaders, and real-time chat windows.</li>
<li><strong>Directory Structure</strong>: A feature-based directory structure (<code>/src/app/(dashboard)/contractor</code>, <code>/src/components/features/leads</code>) keeps the codebase organized.</li>
<li><strong>Styling</strong>: <strong>Tailwind CSS</strong> with <strong>Shadcn/UI</strong> provides a modern, utility-first design system.</li>
<li><strong>Deployment Container</strong>: The application is containerized using a multi-stage <code>Dockerfile</code> that builds the app and copies the optimized standalone output into a lean <code>node:20-alpine</code> image. This creates a small, secure image ideal for Cloud Run.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-cicd"><strong>6. Deployment &amp; DevOps (CI/CD)</strong></h3>
<p>A fully automated CI/CD pipeline using GitHub Actions ensures reliable and frequent deployments to GCP.</p>
<ul>
<li><strong>Environments</strong>: Three isolated GCP projects (<code>homease-ai-dev</code>, <code>-staging</code>, <code>-prod</code>) provide complete separation for Development, Staging, and Production environments.</li>
<li><strong>Branching Strategy</strong>: A GitFlow model is used. Merges to <code>develop</code>, <code>staging</code>, and <code>main</code> branches trigger deployments to their corresponding environments.</li>
<li><strong>Secure Authentication</strong>: <strong>Workload Identity Federation (WIF)</strong> provides a secure, keyless mechanism for GitHub Actions to authenticate with GCP. This eliminates the need to store long-lived service account keys as GitHub secrets.</li>
<li><strong>Workflows</strong>:
<ol>
<li><strong>PR Validation</strong>: On every pull request to <code>develop</code>, a workflow runs linting, type-checking, and tests to maintain code quality.</li>
<li><strong>Frontend Deployment</strong>: On pushes to key branches, a workflow builds the Next.js Docker image, pushes it to <strong>Google Artifact Registry</strong>, and deploys it as a new revision to <strong>Google Cloud Run</strong>. Secrets are securely injected from <strong>Google Secret Manager</strong>.</li>
<li><strong>Backend Deployment</strong>: A separate workflow, triggered by changes in the <code>/functions</code> directory or rules files, uses the Firebase CLI to deploy Cloud Functions, Firestore rules, and Storage rules to the appropriate GCP project.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="7-security-compliance-and-vetting"><strong>7. Security, Compliance, and Vetting</strong></h3>
<p>Security is a foundational principle, integrated at every layer of the platform.</p>
<ul>
<li><strong>Application Security</strong>:
<ul>
<li><strong>Content Security Policy (CSP)</strong>: A strict CSP is enforced via Next.js middleware to prevent XSS attacks.</li>
<li><strong>Input Validation</strong>: <strong>Zod</strong> is used to validate all incoming data on every API endpoint and Cloud Function, preventing injection attacks and ensuring data integrity.</li>
<li><strong>Secure Headers</strong>: Standard security headers (HSTS, X-Content-Type-Options) are configured.</li>
</ul>
</li>
<li><strong>Compliance</strong>:
<ul>
<li><strong>CCPA</strong>: The platform provides users with the right to know, delete, and opt-out of data sales (which HOMEase does not do).</li>
<li><strong>'HIPAA-lite'</strong>: While not a covered entity, HOMEase AI treats home accessibility data as sensitive. We practice <strong>data minimization</strong> (collecting only functional needs, not medical diagnoses) and enforce strict access controls.</li>
<li><strong>Encryption</strong>: All data is encrypted in transit (TLS 1.3) and at rest (Google-managed AES-256).</li>
</ul>
</li>
<li><strong>Contractor Vetting</strong>: A multi-stage process ensures contractor quality.
<ol>
<li><strong>Submission</strong>: Contractors upload licenses and proof of insurance to a secure Cloud Storage bucket.</li>
<li><strong>Verification</strong>: An internal admin team verifies these documents and initiates a third-party background check (e.g., via Checkr).</li>
<li><strong>Status Management</strong>: The contractor's <code>vettingStatus</code> (<code>pending</code>, <code>approved</code>, <code>rejected</code>) is managed in their Firestore document via an admin-only dashboard. Only <code>'approved'</code> contractors are eligible for lead matching.</li>
<li><strong>Secure Storage</strong>: Firebase Storage rules ensure that vetting documents can only be uploaded by the contractor and read by authorized administrators.</li>
</ol>
</li>
</ul>
<h2 id="intermediate-steps">Intermediate Steps</h2>
<h3 id="task-coordinator">Task Coordinator</h3>
<p>Task Understanding:
The user requires a detailed technical architecture plan for the HOMEase AI platform, a lead generation service for home modification contractors. The plan must be based on the provided business documentation, adhere to modern web development best practices, and follow a specific technology stack (Next.js 15, Firebase, Google Cloud). A critical constraint is that the platform must NOT use Vercel for hosting, requiring an alternative deployment strategy on Google Cloud. The final output must be a structured plan suitable for execution by a team of engineers.</p>
<p>Execution Strategy:
The project will be executed in three main phases.
Phase 1: Foundation &amp; Core Architecture. This involves establishing the overall system design, data models, authentication, security protocols, and project structure. This phase is critical as it lays the groundwork for all subsequent development.
Phase 2: Feature Implementation. This phase focuses on building the primary user-facing features, including the Next.js frontend, the AR Assessment flow with AI integration, and the core lead generation and contractor matching logic.
Phase 3: Monetization &amp; Operations. This final phase involves integrating the payment system, refining the contractor onboarding process, and establishing a robust CI/CD pipeline for automated testing and deployment to Google Cloud.</p>
<p>The strategy emphasizes an API-first, serverless, and event-driven approach, leveraging Google Cloud and Firebase services to meet the platform's requirements for scalability, security, and rapid development. The explicit constraint of not using Vercel is addressed by deploying the Next.js application to Google Cloud Run.</p>
<p>Subtasks:</p>
<ol>
<li>Define High-Level System Architecture &amp; GCP Deployment Strategy (Priority: 1, Expertise: Cloud Solutions Architect)
Description: Synthesize the provided business documents to define the high-level system architecture. Create a comprehensive architecture diagram illustrating the interaction between the Next.js frontend (on Google Cloud Run), Firebase services (Auth, Firestore, Storage), Google Cloud Functions, and Pub/Sub. This plan must explicitly address the 'no Vercel' constraint by detailing the Google Cloud Run hosting strategy for the Next.js application.
Dependencies: None</li>
<li>Design Firestore Data Models and Security Rules (Priority: 2, Expertise: Database Architect)
Description: Design the Firestore NoSQL database schema. This includes defining collections for users (with roles for homeowners, contractors, admins), leads, ar-assessments, projects, chat messages, and reviews. Plan for necessary data denormalization to optimize read performance for common queries and design the corresponding Firestore Security Rules to enforce access control based on user roles and data ownership.
Dependencies: t1_architecture_overview</li>
<li>Design Authentication and Role-Based Access Control (RBAC) (Priority: 2, Expertise: Senior Full-Stack Engineer with Security Focus)
Description: Plan the authentication and authorization strategy using NextAuth.js v5 with the Firebase Auth provider. Detail the Role-Based Access Control (RBAC) implementation, including how Firebase custom claims will be used to manage user roles. Document the process for validating these roles on both the Next.js server-side components and within the backend Google Cloud Functions.
Dependencies: t1_architecture_overview</li>
<li>Plan AR Assessment and AI Processing Workflow (Priority: 3, Expertise: AI/ML Integration Specialist)
Description: Detail the end-to-end asynchronous workflow for AR-based home assessments. The plan should cover: 1. Client-side data capture and upload to Firebase Storage. 2. Triggering a Pub/Sub event upon upload completion. 3. A powerful, event-driven Google Cloud Function (Gen 2) that retrieves the data, calls the Google Gemini API for analysis and recommendations, and writes the results back to the corresponding Firestore document.
Dependencies: t1_architecture_overview, t2_data_modeling_and_firestore</li>
<li>Design Lead Generation and Contractor Matching Workflow (Priority: 3, Expertise: Senior Backend Engineer)
Description: Design the asynchronous workflow for lead generation and contractor matching. This includes: 1. An API endpoint in Next.js to receive the initial lead data. 2. Saving the lead to Firestore and publishing a 'lead-created' message to Pub/Sub. 3. A Google Cloud Function that consumes this message, executes the contractor matching algorithm based on location, specialization, and availability, and updates the lead document. 4. Specify the use of Firestore real-time listeners on the frontend to notify users of updates.
Dependencies: t1_architecture_overview, t2_data_modeling_and_firestore, t3_auth_and_rbac_design</li>
<li>Plan Next.js Frontend Architecture and Cloud Run Deployment (Priority: 4, Expertise: Senior Next.js Engineer)
Description: Plan the Next.js 15 application architecture using the App Router. Prioritize React Server Components (RSCs) to minimize client-side JavaScript. Design the deployment process for the Next.js application to Google Cloud Run, including creating an optimized multi-stage Dockerfile and a script for managing environment variables and secrets via Google Secret Manager.
Dependencies: t1_architecture_overview</li>
<li>Design Payment and Contractor Onboarding System (Priority: 5, Expertise: Backend Engineer with Stripe Integration Experience)
Description: Design the payment and contractor onboarding process using Stripe. Plan the integration with Stripe Connect for verifying contractor identities and business details. Design the pay-per-lead transaction flow. Specify the architecture for using Google Cloud Functions to handle Stripe webhooks securely, ensuring that events like 'account.updated' or 'checkout.session.completed' reliably update the relevant Firestore documents.
Dependencies: t3_auth_and_rbac_design, t5_lead_matching_workflow</li>
<li>Plan CI/CD Pipeline with GitHub Actions for GCP (Priority: 6, Expertise: DevOps Engineer)
Description: Design the full CI/CD pipeline using GitHub Actions. Create distinct, reusable workflows for: 1. Linting, type-checking, and running tests on every pull request. 2. A deployment workflow for the Next.js application to Google Cloud Run. 3. A separate deployment workflow for Google Cloud Functions, Firestore rules, and other Firebase assets. The plan must include strategies for managing multiple environments (dev, staging, production).
Dependencies: t1_architecture_overview, t6_nextjs_on_gcp_architecture</li>
<li>Develop Security, Compliance, and Contractor Vetting Plan (Priority: 2, Expertise: Security Architect)
Description: Create a comprehensive security and compliance plan. This includes defining a strict Content Security Policy (CSP), detailing input validation strategies using Zod across all endpoints, and outlining the approach to meet 'HIPAA-lite' and CCPA requirements through data minimization, access logs, and encryption. Also, detail the technical implementation of the multi-stage contractor vetting process, specifying how verification status (licenses, insurance, background checks) will be stored and managed securely.
Dependencies: t2_data_modeling_and_firestore, t3_auth_and_rbac_design</li>
</ol>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtasks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t1_architecture_overview&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cloud Solutions Architect&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Define High-Level System Architecture &amp; GCP Deployment Strategy&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Synthesize the provided business documents to define the high-level system architecture. Create a comprehensive architecture diagram illustrating the interaction between the Next.js frontend (on Google Cloud Run), Firebase services (Auth, Firestore, Storage), Google Cloud Functions, and Pub/Sub. This plan must explicitly address the &#x27;no Vercel&#x27; constraint by detailing the Google Cloud Run hosting strategy for the Next.js application.&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t2_data_modeling_and_firestore&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design the Firestore NoSQL database schema. This includes defining collections for users (with roles for homeowners, contractors, admins), leads, ar-assessments, projects, chat messages, and reviews. Plan for necessary data denormalization to optimize read performance for common queries and design the corresponding Firestore Security Rules to enforce access control based on user roles and data ownership.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Firestore Data Models and Security Rules&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Database Architect&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t3_auth_and_rbac_design&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Full-Stack Engineer with Security Focus&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan the authentication and authorization strategy using NextAuth.js v5 with the Firebase Auth provider. Detail the Role-Based Access Control (RBAC) implementation, including how Firebase custom claims will be used to manage user roles. Document the process for validating these roles on both the Next.js server-side components and within the backend Google Cloud Functions.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Authentication and Role-Based Access Control (RBAC)&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t4_ar_assessment_and_ai_flow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AI/ML Integration Specialist&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan AR Assessment and AI Processing Workflow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Detail the end-to-end asynchronous workflow for AR-based home assessments. The plan should cover: 1. Client-side data capture and upload to Firebase Storage. 2. Triggering a Pub/Sub event upon upload completion. 3. A powerful, event-driven Google Cloud Function (Gen 2) that retrieves the data, calls the Google Gemini API for analysis and recommendations, and writes the results back to the corresponding Firestore document.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t2_data_modeling_and_firestore&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t5_lead_matching_workflow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design the asynchronous workflow for lead generation and contractor matching. This includes: 1. An API endpoint in Next.js to receive the initial lead data. 2. Saving the lead to Firestore and publishing a &#x27;lead-created&#x27; message to Pub/Sub. 3. A Google Cloud Function that consumes this message, executes the contractor matching algorithm based on location, specialization, and availability, and updates the lead document. 4. Specify the use of Firestore real-time listeners on the frontend to notify users of updates.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Backend Engineer&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Lead Generation and Contractor Matching Workflow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t2_data_modeling_and_firestore&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t3_auth_and_rbac_design&quot;</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t6_nextjs_on_gcp_architecture&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Next.js Engineer&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan the Next.js 15 application architecture using the App Router. Prioritize React Server Components (RSCs) to minimize client-side JavaScript. Design the deployment process for the Next.js application to Google Cloud Run, including creating an optimized multi-stage Dockerfile and a script for managing environment variables and secrets via Google Secret Manager.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan Next.js Frontend Architecture and Cloud Run Deployment&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t3_auth_and_rbac_design&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t5_lead_matching_workflow&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design the payment and contractor onboarding process using Stripe. Plan the integration with Stripe Connect for verifying contractor identities and business details. Design the pay-per-lead transaction flow. Specify the architecture for using Google Cloud Functions to handle Stripe webhooks securely, ensuring that events like &#x27;account.updated&#x27; or &#x27;checkout.session.completed&#x27; reliably update the relevant Firestore documents.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t7_payments_and_onboarding&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Engineer with Stripe Integration Experience&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Payment and Contractor Onboarding System&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t1_architecture_overview&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t6_nextjs_on_gcp_architecture&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DevOps Engineer&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t8_cicd_and_devops_plan&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design the full CI/CD pipeline using GitHub Actions. Create distinct, reusable workflows for: 1. Linting, type-checking, and running tests on every pull request. 2. A deployment workflow for the Next.js application to Google Cloud Run. 3. A separate deployment workflow for Google Cloud Functions, Firestore rules, and other Firebase assets. The plan must include strategies for managing multiple environments (dev, staging, production).&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan CI/CD Pipeline with GitHub Actions for GCP&quot;</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;required_expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Security Architect&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Create a comprehensive security and compliance plan. This includes defining a strict Content Security Policy (CSP), detailing input validation strategies using Zod across all endpoints, and outlining the approach to meet &#x27;HIPAA-lite&#x27; and CCPA requirements through data minimization, access logs, and encryption. Also, detail the technical implementation of the multi-stage contractor vetting process, specifying how verification status (licenses, insurance, background checks) will be stored and managed securely.&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t9_security_and_compliance&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;t2_data_modeling_and_firestore&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;t3_auth_and_rbac_design&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop Security, Compliance, and Contractor Vetting Plan&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;execution_strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The project will be executed in three main phases. \nPhase 1: Foundation &amp; Core Architecture. This involves establishing the overall system design, data models, authentication, security protocols, and project structure. This phase is critical as it lays the groundwork for all subsequent development.\nPhase 2: Feature Implementation. This phase focuses on building the primary user-facing features, including the Next.js frontend, the AR Assessment flow with AI integration, and the core lead generation and contractor matching logic.\nPhase 3: Monetization &amp; Operations. This final phase involves integrating the payment system, refining the contractor onboarding process, and establishing a robust CI/CD pipeline for automated testing and deployment to Google Cloud.\n\nThe strategy emphasizes an API-first, serverless, and event-driven approach, leveraging Google Cloud and Firebase services to meet the platform&#x27;s requirements for scalability, security, and rapid development. The explicit constraint of not using Vercel is addressed by deploying the Next.js application to Google Cloud Run.&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;task_understanding&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The user requires a detailed technical architecture plan for the HOMEase AI platform, a lead generation service for home modification contractors. The plan must be based on the provided business documentation, adhere to modern web development best practices, and follow a specific technology stack (Next.js 15, Firebase, Google Cloud). A critical constraint is that the platform must NOT use Vercel for hosting, requiring an alternative deployment strategy on Google Cloud. The final output must be a structured plan suitable for execution by a team of engineers.&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="cloud-solutions-architect-specialist">Cloud Solutions Architect Specialist</h3>
<p>Here is the detailed technical architecture plan for the HOMEase AI platform, with a specific focus on the high-level system architecture and deployment strategy on Google Cloud.</p>
<h3 id="homease-ai-technical-architecture-plan"><strong>HOMEase AI: Technical Architecture Plan</strong></h3>
<p>This document outlines the technical architecture for the HOMEase AI platform. It is designed to be scalable, secure, and capital-efficient, aligning with the business's strategic pivot to a pure-play lead generation model.</p>
<p><strong>A critical constraint of this plan is the explicit exclusion of Vercel for deployment.</strong> The architecture is therefore centered entirely within the Google Cloud Platform (GCP) ecosystem to ensure seamless integration, unified billing, and consolidated security management.</p>
<hr>
<h3 id="1-high-level-system-architecture-1"><strong>1. High-Level System Architecture</strong></h3>
<p>HOMEase AI will be built on a serverless, event-driven architecture hosted exclusively on Google Cloud Platform. This model is chosen for its inherent scalability, cost-effectiveness (pay-for-what-you-use), and reduced operational overhead, directly supporting the business goals of being &quot;cheaper to run&quot; and &quot;easy to scale.&quot;</p>
<p>The architecture is logically divided into four main tiers:</p>
<ol>
<li><strong>Client Tier:</strong> The user-facing applications, including the homeowner's AR-enabled web app and the contractor's dashboard.</li>
<li><strong>Application &amp; API Tier:</strong> The core business logic, serving client requests and orchestrating backend processes. This is handled by a Next.js application and dedicated serverless functions.</li>
<li><strong>Asynchronous Processing Tier:</strong> The engine for handling computationally intensive, long-running, or non-blocking tasks like AR data analysis and lead matching.</li>
<li><strong>Data &amp; Persistence Tier:</strong> The unified backend for storing, managing, and securing all platform data, from user profiles to AR scans.</li>
</ol>
<h4 id="11-core-technology-stack-1"><strong>1.1. Core Technology Stack</strong></h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (with App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run (for the Next.js application)</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication (integrated with NextAuth.js v5)</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (for analysis), <a href="http://Fal.ai">Fal.ai</a> (for visualization)</li>
<li><strong>Payments:</strong> Stripe</li>
<li><strong>CI/CD:</strong> Google Cloud Build &amp; GitHub Actions</li>
</ul>
<h4 id="12-architecture-diagram-1"><strong>1.2. Architecture Diagram</strong></h4>
<p>The following diagram illustrates the flow of information and interaction between the system components.</p>
<pre><code class="language-mermaid">graph TD
    subgraph &quot;User Devices&quot;
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph &quot;Google Cloud Platform&quot;
        subgraph &quot;Application &amp; API Tier&quot;
            C(Next.js App on Cloud Run)
        end

        subgraph &quot;Asynchronous Processing Tier&quot;
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
        end

        subgraph &quot;Data &amp; Persistence Tier&quot;
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph &quot;External Services&quot;
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C

    %% Authentication Flow
    C -- Authenticates User --&gt; H

    %% Synchronous Data Flow
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J

    %% Asynchronous Lead Creation Flow
    C -- Publishes Message --&gt; D
    D -- Triggers --&gt; F
    F -- Reads Data --&gt; I
    F -- Writes Match Results --&gt; I

    %% Asynchronous AR Processing Flow
    C -- Publishes Message --&gt; E
    E -- Triggers --&gt; G
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Analysis Results --&gt; I

    %% Payment Flow
    C -- Initiates Payment --&gt; L

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</code></pre>
<h4 id="13-component-interaction--key-flows"><strong>1.3. Component Interaction &amp; Key Flows</strong></h4>
<ul>
<li><strong>User Interaction:</strong> Both Homeowners and Contractors access the platform via a single, responsive Next.js application. Role-based access control (RBAC) within the Next.js backend will serve the appropriate UI and data for each user type.</li>
<li><strong>Authentication:</strong> A user signs up or logs in via the Next.js app. NextAuth.js, using the Firebase Auth adapter, handles the authentication flow. Firebase Auth securely manages user credentials and issues tokens, which are validated by the Next.js backend on every request.</li>
<li><strong>Lead Creation (Event-Driven):</strong>
<ol>
<li>A homeowner submits a new lead request through the Next.js UI.</li>
<li>The Next.js backend API (<code>/api/leads</code>) validates the input (using Zod) and writes the initial lead data to a <code>leads</code> collection in Firestore.</li>
<li>Immediately after, it publishes a message with the <code>leadId</code> to the <code>lead-created</code> Pub/Sub topic. This decouples the API response from the heavy lifting of matching.</li>
<li>The <code>leadMatching</code> Cloud Function, subscribed to this topic, is triggered. It performs the complex logic of finding suitable contractors based on location, specialty, and availability.</li>
<li>The function updates the lead document in Firestore with the matched contractors.</li>
<li>The homeowner and matched contractors receive real-time updates in their dashboards via Firestore's real-time listeners.</li>
</ol>
</li>
<li><strong>AR Processing (Event-Driven):</strong>
<ol>
<li>A homeowner uploads AR scan data (images, measurements) through the Next.js app.</li>
<li>The Next.js backend uploads the large files to Cloud Storage and creates an initial assessment document in Firestore with a <code>status: 'processing'</code> flag.</li>
<li>It then publishes a message with the <code>assessmentId</code> to the <code>ar-assessment-created</code> Pub/Sub topic.</li>
<li>The <code>arProcessing</code> Cloud Function is triggered. This function retrieves the data from Cloud Storage, sends it to the Google Gemini API for hazard detection/recommendations and to <a href="http://Fal.ai">Fal.ai</a> for visualization.</li>
<li>Upon receiving the results, the function updates the assessment document in Firestore with the detailed analysis, hazard list, and generated &quot;after&quot; images. The status is changed to <code>status: 'complete'</code>.</li>
<li>The homeowner's UI, listening to this document, automatically updates to display the completed assessment.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="2-deployment-strategy-nextjs-on-google-cloud-run-no-vercel"><strong>2. Deployment Strategy: Next.js on Google Cloud Run (No Vercel)</strong></h3>
<p>To adhere to the &quot;no Vercel&quot; constraint while maintaining a modern, scalable deployment for the Next.js 15 application, we will use <strong>Google Cloud Run</strong>. Cloud Run is a fully managed serverless platform that allows us to run stateless containers. It is the ideal GCP-native solution for hosting a full-stack Next.js application.</p>
<h4 id="21-containerization-with-docker"><strong>2.1. Containerization with Docker</strong></h4>
<p>The Next.js application will be containerized using Docker. A multi-stage <code>Dockerfile</code> will be created to optimize the production image for size and security.</p>
<ul>
<li><strong>Stage 1 (Builder):</strong> Installs dependencies, builds the Next.js application (<code>npm run build</code>), and prunes development-only dependencies.</li>
<li><strong>Stage 2 (Runner):</strong> Copies the built application (<code>.next</code> directory, <code>public</code>, <code>package.json</code>, <code>node_modules</code>) into a lean base image (e.g., <code>node:20-alpine</code>). It exposes the required port (e.g., 3000) and defines the command to start the Next.js server (<code>npm start</code>).</li>
</ul>
<h4 id="22-cicd-with-google-cloud-build-and-artifact-registry"><strong>2.2. CI/CD with Google Cloud Build and Artifact Registry</strong></h4>
<p>We will implement a fully automated CI/CD pipeline using GitHub Actions and Google Cloud Build.</p>
<ol>
<li><strong>Trigger:</strong> A push or merge to the <code>main</code> or <code>production</code> branch in the GitHub repository triggers the pipeline.</li>
<li><strong>Build:</strong> A <code>cloudbuild.yaml</code> file in the repository root defines the build steps for Google Cloud Build.
<ul>
<li>It builds the Docker image using the project's <code>Dockerfile</code>.</li>
<li>It tags the image with the commit SHA for versioning.</li>
</ul>
</li>
<li><strong>Store:</strong> The newly built container image is pushed to <strong>Google Artifact Registry</strong>, which serves as our private, secure Docker registry.</li>
<li><strong>Deploy:</strong> The final step in the Cloud Build pipeline deploys the new image as a revision to our <strong>Google Cloud Run service</strong>. Cloud Build will use a service account with the necessary permissions (<code>roles/run.admin</code>, <code>roles/iam.serviceAccountUser</code>) to perform this action.</li>
</ol>
<p>This setup ensures that every push to the main branch results in a tested, versioned, and automatically deployed update to the production environment with zero downtime.</p>
<h4 id="23-cloud-run-service-configuration"><strong>2.3. Cloud Run Service Configuration</strong></h4>
<p>The HOMEase AI Cloud Run service will be configured for performance, scalability, and security:</p>
<ul>
<li><strong>CPU &amp; Memory:</strong> Allocated based on performance testing (e.g., 1 vCPU, 1GiB memory to start).</li>
<li><strong>Scalability:</strong>
<ul>
<li><strong>Min Instances:</strong> Set to <code>1</code> to mitigate cold starts for a better user experience, especially during initial launch phases. Can be set to <code>0</code> to optimize for cost if traffic is highly variable.</li>
<li><strong>Max Instances:</strong> Set to a reasonable limit (e.g., <code>20</code>) to handle traffic spikes while controlling costs.</li>
</ul>
</li>
<li><strong>Concurrency:</strong> Configured to allow multiple concurrent requests per container instance (e.g., 80), which is typical for efficient Node.js applications.</li>
<li><strong>Environment Variables &amp; Secrets:</strong>
<ul>
<li>Non-sensitive variables (e.g., <code>NEXT_PUBLIC_FIREBASE_API_KEY</code>) are set directly in the Cloud Run service configuration.</li>
<li>All sensitive keys (<code>STRIPE_SECRET_KEY</code>, <code>GOOGLE_GENAI_API_KEY</code>, <code>NEXTAUTH_SECRET</code>) will be stored in <strong>Google Secret Manager</strong> and securely mounted into the Cloud Run service at runtime. This is a critical security best practice.</li>
</ul>
</li>
<li><strong>Networking:</strong> The service will be configured to allow public access (all traffic) and will be fronted by a <strong>Google Cloud Load Balancer</strong> with a managed SSL certificate for the custom domain (<code>app.homease.ai</code>). The load balancer also provides CDN capabilities (via Cloud CDN) for caching static assets, further improving performance.</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t1_architecture_overview&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Define High-Level System Architecture &amp; GCP Deployment Strategy&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Cloud Solutions Architect&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="database-architect-specialist">Database Architect Specialist</h3>
<p>Here is the detailed plan for the Firestore data models and security rules for the HOMEase AI platform.</p>
<hr>
<h3 id="3-data-modeling--firestore-schema"><strong>3. Data Modeling &amp; Firestore Schema</strong></h3>
<p>The Firestore NoSQL database is structured to optimize for the primary access patterns of the application, such as fetching leads for a contractor or displaying a homeowner's project history. The design employs denormalization strategically to ensure fast read performance and reduce the number of queries required for common UI views.</p>
<h4 id="31-collection-structure"><strong>3.1. Collection Structure</strong></h4>
<p>The following collections form the core of the database schema.</p>
<p><strong>1. <code>users</code></strong>
Stores profile information for all user types. A single collection is used to simplify authentication and user management.</p>
<ul>
<li><strong>Document ID:</strong> <code>userId</code> (from Firebase Authentication <code>uid</code>)</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;uid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Firebase Auth UID</span>
  <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;photoURL&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// URL to profile picture</span>
  <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;homeowner&#x27;, &#x27;contractor&#x27;, &#x27;admin&#x27;</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;phoneNumber&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// optional</span>
  <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;street&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;city&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;state&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;zip&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

  <span class="hljs-comment">// --- Contractor-Specific Fields ---</span>
  <span class="hljs-attr">&quot;contractorProfile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;companyName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;vettingStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;pending&#x27;, &#x27;approved&#x27;, &#x27;rejected&#x27;</span>
    <span class="hljs-attr">&quot;licenseNumber&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;insuranceVerified&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;boolean&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;capsCertified&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;boolean&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;specialties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// e.g., [&#x27;ramp-construction&#x27;, &#x27;bathroom-remodel&#x27;]</span>
    <span class="hljs-attr">&quot;serviceAreaZips&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Array of zip codes served</span>
    <span class="hljs-attr">&quot;bio&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// Denormalized for performance</span>
    <span class="hljs-attr">&quot;averageRating&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;number&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Calculated by a Cloud Function</span>
    <span class="hljs-attr">&quot;reviewCount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;number&quot;</span>    <span class="hljs-comment">// Calculated by a Cloud Function</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<p><strong>2. <code>leads</code></strong>
Represents a work request initiated by a homeowner.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;homeownerId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// UID of the creating user</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;new&#x27;, &#x27;matching&#x27;, &#x27;matched&#x27;, &#x27;in_progress&#x27;, &#x27;closed&#x27;, &#x27;cancelled&#x27;</span>
  <span class="hljs-attr">&quot;urgency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;low&#x27;, &#x27;medium&#x27;, &#x27;high&#x27;</span>
  <span class="hljs-attr">&quot;budgetRange&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// e.g., &#x27;$5k-$10k&#x27;</span>
  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;updatedAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;arAssessmentId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Link to the &#x27;ar-assessments&#x27; document</span>

  <span class="hljs-comment">// --- Denormalized Homeowner Info ---</span>
  <span class="hljs-attr">&quot;homeownerInfo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;displayName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;city&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;state&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;zip&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

  <span class="hljs-comment">// --- Matched Contractor Info ---</span>
  <span class="hljs-attr">&quot;matchedContractorIds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Array of matched contractor UIDs</span>
  <span class="hljs-attr">&quot;viewedByContractors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// Array of UIDs of contractors who have viewed the lead</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<p><strong>3. <code>ar-assessments</code></strong>
Stores the data and results from an AR scan.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// UID of the homeowner who created it</span>
  <span class="hljs-attr">&quot;leadId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Link back to the lead if applicable</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;pending&#x27;, &#x27;processing&#x27;, &#x27;complete&#x27;, &#x27;failed&#x27;</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;storageRefs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Paths to raw data in Cloud Storage</span>
    <span class="hljs-attr">&quot;video&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;measurementsJson&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;results&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;hazards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;severity&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;number&quot;</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;recommendations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">&quot;modification&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;details&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;visualizationUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-comment">// URL to the &#x27;after&#x27; image from Fal.ai</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<p><strong>4. <code>projects</code></strong>
Represents a confirmed job between a homeowner and a contractor.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;leadId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;homeownerId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;contractorId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// &#x27;upcoming&#x27;, &#x27;active&#x27;, &#x27;completed&#x27;, &#x27;disputed&#x27;</span>
  <span class="hljs-attr">&quot;scopeOfWork&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Finalized SOW</span>
  <span class="hljs-attr">&quot;finalBudget&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;number&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;startDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;completionDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;chatId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-comment">// Link to the &#x27;chats&#x27; document for this project</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<p><strong>5. <code>chats</code></strong>
A top-level collection to manage conversation threads.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated (or a composite key like <code>{leadId}_{contractorId}</code>)</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;participantIds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// [homeownerId, contractorId]</span>
  <span class="hljs-attr">&quot;lastMessage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li><strong>Subcollection:</strong> <code>messages</code>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;senderId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;readBy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<p><strong>6. <code>reviews</code></strong>
Stores ratings and feedback for completed projects.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated (or <code>projectId</code> for uniqueness)</li>
<li><strong>Structure:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;projectId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;homeownerId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;contractorId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;rating&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;number&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 1-5</span>
  <span class="hljs-attr">&quot;comment&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;timestamp&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>Note:</strong> A Cloud Function will be triggered <code>onWrite</code> to this collection to update the <code>averageRating</code> and <code>reviewCount</code> fields in the contractor's <code>users</code> document.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="32-firestore-security-rules"><strong>3.2. Firestore Security Rules</strong></h3>
<p>These rules enforce the business logic at the database layer, ensuring users can only access data they are authorized to see. This is a critical security measure that works independently of the application backend.</p>
<p>Filename: <code>firestore.rules</code></p>
<pre><code class="language-javascript">rules_version = <span class="hljs-string">&#x27;2&#x27;</span>;

service cloud.<span class="hljs-property">firestore</span> {
  match /databases/{database}/documents {

    <span class="hljs-comment">// --- Helper Functions ---</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isSignedIn</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">auth</span> != <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isUser</span>(<span class="hljs-params">userId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == userId;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">userId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/users/$(userId)).<span class="hljs-property">data</span>;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isRole</span>(<span class="hljs-params">role</span>) {
      <span class="hljs-keyword">let</span> userRole = <span class="hljs-title function_">getUserData</span>(request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>).<span class="hljs-property">role</span>;
      <span class="hljs-keyword">return</span> userRole == role;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isAdmin</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; <span class="hljs-title function_">isRole</span>(<span class="hljs-string">&#x27;admin&#x27;</span>);
    }

    <span class="hljs-comment">// --- Collection Rules ---</span>

    <span class="hljs-comment">// USERS: Users can manage their own profile. Admins have full access.</span>
    <span class="hljs-comment">// Public contractor data is readable by anyone signed in.</span>
    match /users/{userId} {
      allow <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (<span class="hljs-title function_">isUser</span>(userId) || <span class="hljs-title function_">getUserData</span>(userId).<span class="hljs-property">role</span> == <span class="hljs-string">&#x27;contractor&#x27;</span>);
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">uid</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;
      allow <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isUser</span>(userId) || <span class="hljs-title function_">isAdmin</span>();
      <span class="hljs-comment">// No user should be able to delete their own account via a direct API call.</span>
      allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAdmin</span>();
    }

    <span class="hljs-comment">// LEADS: Homeowners can create/manage their own leads. Matched contractors can read them.</span>
    match /leads/{leadId} {
      allow <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (
                    <span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span>) ||
                    request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> resource.<span class="hljs-property">data</span>.<span class="hljs-property">matchedContractorIds</span> ||
                    <span class="hljs-title function_">isAdmin</span>()
                  );
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; <span class="hljs-title function_">isRole</span>(<span class="hljs-string">&#x27;homeowner&#x27;</span>) &amp;&amp;
                     request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;
      allow <span class="hljs-attr">update</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (<span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span>) || <span class="hljs-title function_">isAdmin</span>());
      allow <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (<span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span>) || <span class="hljs-title function_">isAdmin</span>());
    }

    <span class="hljs-comment">// AR-ASSESSMENTS: Only the creating user and admins can access.</span>
    match /ar-assessments/{assessmentId} {
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (<span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">userId</span>) || <span class="hljs-title function_">isAdmin</span>());
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; <span class="hljs-title function_">isRole</span>(<span class="hljs-string">&#x27;homeowner&#x27;</span>) &amp;&amp;
                     request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;
    }

    <span class="hljs-comment">// PROJECTS: Only the involved homeowner, contractor, or an admin can access.</span>
    match /projects/{projectId} {
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; (
                           <span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span>) ||
                           <span class="hljs-title function_">isUser</span>(resource.<span class="hljs-property">data</span>.<span class="hljs-property">contractorId</span>) ||
                           <span class="hljs-title function_">isAdmin</span>()
                         );
      <span class="hljs-comment">// Project creation is handled by server-side logic (Cloud Function), not direct client access.</span>
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAdmin</span>(); <span class="hljs-comment">// Or a specific server role if configured</span>
    }

    <span class="hljs-comment">// CHATS &amp; MESSAGES: Only participants in the chat can read/write messages.</span>
    match /chats/{chatId} {
      <span class="hljs-comment">// Allow reading/writing the chat document metadata if you are a participant.</span>
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> resource.<span class="hljs-property">data</span>.<span class="hljs-property">participantIds</span>;

      <span class="hljs-comment">// Rules for the messages subcollection</span>
      match /messages/{messageId} {
        allow read, <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp;
                             request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> <span class="hljs-keyword">in</span> <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/chats/$(chatId)).<span class="hljs-property">data</span>.<span class="hljs-property">participantIds</span>;
        <span class="hljs-comment">// Messages are immutable once sent.</span>
        allow update, <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAdmin</span>();
      }
    }

    <span class="hljs-comment">// REVIEWS: Homeowners can create reviews for projects they were part of.</span>
    <span class="hljs-comment">// Reviews are public to read but cannot be modified after creation except by an admin.</span>
    match /reviews/{reviewId} {
      allow <span class="hljs-attr">read</span>: <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Reviews are public</span>
      allow <span class="hljs-attr">create</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isSignedIn</span>() &amp;&amp; <span class="hljs-title function_">isRole</span>(<span class="hljs-string">&#x27;homeowner&#x27;</span>) &amp;&amp;
                     <span class="hljs-comment">// Verify the user was the homeowner on the completed project.</span>
                     <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/projects/$(request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">projectId</span>)).<span class="hljs-property">data</span>.<span class="hljs-property">homeownerId</span> == request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> &amp;&amp;
                     <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/projects/$(request.<span class="hljs-property">resource</span>.<span class="hljs-property">data</span>.<span class="hljs-property">projectId</span>)).<span class="hljs-property">data</span>.<span class="hljs-property">status</span> == <span class="hljs-string">&#x27;completed&#x27;</span>;
      <span class="hljs-comment">// Reviews are immutable by users.</span>
      allow update, <span class="hljs-attr">delete</span>: <span class="hljs-keyword">if</span> <span class="hljs-title function_">isAdmin</span>();
    }
  }
}
</code></pre>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t2_data_modeling_and_firestore&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Firestore Data Models and Security Rules&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Database Architect&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="senior-full-stack-engineer-with-security-focus-specialist">Senior Full-Stack Engineer with Security Focus Specialist</h3>
<p>Here is the detailed technical plan for Authentication and Role-Based Access Control (RBAC) for the HOMEase AI platform.</p>
<hr>
<h3 id="3-authentication-and-role-based-access-control-rbac"><strong>3. Authentication and Role-Based Access Control (RBAC)</strong></h3>
<p>This section details the authentication and authorization strategy for the HOMEase AI platform. The implementation leverages NextAuth.js v5 with the Firebase Auth provider, using Firebase Custom Claims as the cornerstone for a robust and secure Role-Based Access Control (RBAC) system. This approach ensures that user identity is managed securely by Firebase, while access control is enforced consistently across the entire architecture, from the Next.js frontend to the backend Google Cloud Functions.</p>
<h4 id="31-authentication-flow-and-user-signup"><strong>3.1. Authentication Flow and User Signup</strong></h4>
<p>The authentication flow is designed to be secure and provide a seamless user experience. It differentiates between the platform's two primary user typeshomeowners and contractorsfrom the moment of registration.</p>
<ol>
<li><strong>User Registration:</strong> The Next.js application will feature distinct registration paths: one for &quot;Homeowners&quot; and another for &quot;Contractors.&quot;
<ul>
<li>A user selects their desired role and provides standard credentials (email/password or signs in with a social provider like Google).</li>
<li>The frontend client calls the NextAuth.js sign-in/sign-up handler.</li>
</ul>
</li>
<li><strong>Firebase User Creation:</strong> NextAuth.js, configured with the Firebase Adapter, communicates with Firebase Authentication to create a new user record. At this point, the user is authenticated but has no specific role assigned within the system's logic.</li>
<li><strong>Role Assignment (Server-Side Trigger):</strong> To securely assign a role, we will use a <strong><code>onUserCreate</code> Google Cloud Function</strong>.
<ul>
<li>During the signup process in the Next.js app, along with creating the user, a corresponding document is created in a temporary Firestore collection (e.g., <code>pending_users/{userId}</code>) containing the intended role (e.g., <code>{ role: 'homeowner' }</code>).</li>
<li>The <code>onUserCreate</code> function triggers, reads the corresponding document from <code>pending_users</code>, and uses the Firebase Admin SDK to set a <strong>custom claim</strong> on the newly created user account.</li>
<li>After setting the claim, the temporary document in <code>pending_users</code> is deleted. This ensures roles are only ever assigned by trusted server-side code, not by the client.</li>
</ul>
</li>
<li><strong>Session Creation:</strong> Upon subsequent logins, Firebase Auth issues an ID token to the user. This JWT contains the custom claim (e.g., <code>{ &quot;role&quot;: &quot;contractor&quot; }</code>), which is cryptographically signed by Google.</li>
<li><strong>Session Propagation:</strong> NextAuth.js receives this ID token. Its session management callbacks are configured to decode the token, extract the custom claim, and inject the <code>role</code> into the NextAuth.js session object. This makes the user's role available throughout the Next.js application.</li>
</ol>
<h4 id="32-role-management-with-firebase-custom-claims"><strong>3.2. Role Management with Firebase Custom Claims</strong></h4>
<p>Custom claims are the authoritative source for user roles. They are secure, as they can only be modified by a privileged server environment (using the Firebase Admin SDK), and efficient, as they are embedded directly into the user's ID token, eliminating the need for extra database lookups on every request to check permissions.</p>
<ul>
<li>
<p><strong>Defined Roles:</strong></p>
<ul>
<li><code>homeowner</code>: Can create and manage their own AR assessments and leads. Can communicate with matched contractors.</li>
<li><code>contractor</code>: Can view and purchase leads, manage their profile, and communicate with homeowners.</li>
<li><code>admin</code>: Can access an administrative dashboard to manage users, oversee platform activity, and resolve disputes.</li>
</ul>
</li>
<li>
<p><strong>Setting Claims via Cloud Function (<code>functions/src/auth.ts</code>):</strong></p>
</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> functions <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-functions&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> admin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-admin&quot;</span>;

<span class="hljs-comment">// Initialize Admin SDK if not already done</span>
<span class="hljs-keyword">if</span> (admin.<span class="hljs-property">apps</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
  admin.<span class="hljs-title function_">initializeApp</span>();
}

<span class="hljs-comment">/**
 * Triggered on new user creation. Reads the intended role from a
 * &#x27;pending_users&#x27; collection and sets it as a custom claim.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> assignRoleOnCreate = functions.<span class="hljs-property">auth</span>.<span class="hljs-title function_">user</span>().<span class="hljs-title function_">onCreate</span>(<span class="hljs-keyword">async</span> (user) =&gt; {
  <span class="hljs-keyword">const</span> firestore = admin.<span class="hljs-title function_">firestore</span>();
  <span class="hljs-keyword">const</span> pendingUserRef = firestore.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;pending_users&quot;</span>).<span class="hljs-title function_">doc</span>(user.<span class="hljs-property">uid</span>);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> userDoc = <span class="hljs-keyword">await</span> pendingUserRef.<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">if</span> (!userDoc.<span class="hljs-property">exists</span>) {
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`No pending role document found for user: <span class="hljs-subst">${user.uid}</span>. Defaulting to &#x27;homeowner&#x27;.`</span>);
      <span class="hljs-keyword">await</span> admin.<span class="hljs-title function_">auth</span>().<span class="hljs-title function_">setCustomUserClaims</span>(user.<span class="hljs-property">uid</span>, { <span class="hljs-attr">role</span>: <span class="hljs-string">&quot;homeowner&quot;</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> userData = userDoc.<span class="hljs-title function_">data</span>();
    <span class="hljs-keyword">const</span> role = userData?.<span class="hljs-property">role</span>;

    <span class="hljs-keyword">if</span> (role &amp;&amp; [<span class="hljs-string">&quot;homeowner&quot;</span>, <span class="hljs-string">&quot;contractor&quot;</span>].<span class="hljs-title function_">includes</span>(role)) {
      <span class="hljs-keyword">await</span> admin.<span class="hljs-title function_">auth</span>().<span class="hljs-title function_">setCustomUserClaims</span>(user.<span class="hljs-property">uid</span>, { role });
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Custom claim &#x27;<span class="hljs-subst">${role}</span>&#x27; set for user: <span class="hljs-subst">${user.uid}</span>`</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Default or handle invalid role</span>
      <span class="hljs-keyword">await</span> admin.<span class="hljs-title function_">auth</span>().<span class="hljs-title function_">setCustomUserClaims</span>(user.<span class="hljs-property">uid</span>, { <span class="hljs-attr">role</span>: <span class="hljs-string">&quot;homeowner&quot;</span> });
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Invalid or no role specified for <span class="hljs-subst">${user.uid}</span>. Defaulting to &#x27;homeowner&#x27;.`</span>);
    }

    <span class="hljs-comment">// Clean up the temporary document</span>
    <span class="hljs-keyword">await</span> pendingUserRef.<span class="hljs-title function_">delete</span>();

  } <span class="hljs-keyword">catch</span> (error) {
    functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error setting custom claim for user <span class="hljs-subst">${user.uid}</span>`</span>, error);
  }
});
</code></pre>
<h4 id="33-nextauthjs-v5-configuration"><strong>3.3. NextAuth.js v5 Configuration</strong></h4>
<p>The core of the integration lies in the <code>auth.ts</code> configuration file. It connects to Firebase and ensures the custom <code>role</code> claim is added to the session.</p>
<ul>
<li><strong>File:</strong> <code>auth.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">NextAuth</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next-auth&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FirestoreAdapter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@auth/firebase-adapter&quot;</span>;
<span class="hljs-keyword">import</span> { firestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/firebase/admin&quot;</span>; <span class="hljs-comment">// Your Firestore admin instance</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Google</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next-auth/providers/google&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Email</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next-auth/providers/email&quot;</span>; <span class="hljs-comment">// For passwordless or email/pass</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { handlers, signIn, signOut, auth } = <span class="hljs-title class_">NextAuth</span>({
  <span class="hljs-attr">providers</span>: [
    <span class="hljs-title class_">Google</span>,
    <span class="hljs-comment">// Add other providers like Email/Password if needed</span>
  ],
  <span class="hljs-attr">adapter</span>: <span class="hljs-title class_">FirestoreAdapter</span>(firestore),
  <span class="hljs-attr">session</span>: {
    <span class="hljs-attr">strategy</span>: <span class="hljs-string">&quot;jwt&quot;</span>, <span class="hljs-comment">// Using JWTs is essential for this flow</span>
  },
  <span class="hljs-attr">callbacks</span>: {
    <span class="hljs-comment">// This callback injects the custom claim into the NextAuth token</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">jwt</span>(<span class="hljs-params">{ token, user }</span>) {
      <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-comment">// On initial sign-in, user object is available</span>
        <span class="hljs-keyword">const</span> firebaseUser = <span class="hljs-keyword">await</span> admin.<span class="hljs-title function_">auth</span>().<span class="hljs-title function_">getUser</span>(user.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">const</span> role = firebaseUser.<span class="hljs-property">customClaims</span>?.<span class="hljs-property">role</span> || <span class="hljs-string">&#x27;homeowner&#x27;</span>;
        token.<span class="hljs-property">role</span> = role;
      }
      <span class="hljs-keyword">return</span> token;
    },
    <span class="hljs-comment">// This callback injects the role from the token into the client-side session</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">session</span>(<span class="hljs-params">{ session, token }</span>) {
      <span class="hljs-keyword">if</span> (session.<span class="hljs-property">user</span>) {
        session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> = token.<span class="hljs-property">sub</span>; <span class="hljs-comment">// Ensure user ID is in the session</span>
        session.<span class="hljs-property">user</span>.<span class="hljs-property">role</span> = token.<span class="hljs-property">role</span>; <span class="hljs-comment">// Add role to the session user object</span>
      }
      <span class="hljs-keyword">return</span> session;
    },
  },
});

<span class="hljs-comment">// Augment the default session and user types for TypeScript</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&quot;next-auth&quot;</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Session</span> {
    <span class="hljs-attr">user</span>: {
      role?: <span class="hljs-string">&quot;homeowner&quot;</span> | <span class="hljs-string">&quot;contractor&quot;</span> | <span class="hljs-string">&quot;admin&quot;</span>;
    } &amp; <span class="hljs-title class_">DefaultSession</span>[<span class="hljs-string">&quot;user&quot;</span>];
  }
}
</code></pre>
<h4 id="34-enforcing-rbac-in-the-nextjs-application"><strong>3.4. Enforcing RBAC in the Next.js Application</strong></h4>
<p>With the <code>role</code> available in the session object, enforcing access control becomes straightforward and declarative.</p>
<ul>
<li><strong>Protecting Server Components and Pages:</strong></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// app/contractor/dashboard/page.tsx</span>
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/auth&quot;</span>;
<span class="hljs-keyword">import</span> { redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/navigation&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContractorDashboardPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">auth</span>();

  <span class="hljs-keyword">if</span> (session?.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> !== <span class="hljs-string">&#x27;contractor&#x27;</span>) {
    <span class="hljs-comment">// Or redirect to a dedicated &quot;unauthorized&quot; page</span>
    <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to your Contractor Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* Contractor-specific components and data */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><strong>Protecting API Routes (Route Handlers):</strong></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// app/api/leads/purchase/route.ts</span>
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/auth&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">auth</span>();

  <span class="hljs-keyword">if</span> (session?.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> !== <span class="hljs-string">&#x27;contractor&#x27;</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Forbidden&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">403</span> });
  }

  <span class="hljs-comment">// Logic for a contractor to purchase a lead...</span>
  <span class="hljs-keyword">const</span> { leadId } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, leadId });
}
</code></pre>
<ul>
<li><strong>Conditionally Rendering UI (Client Components):</strong></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// components/Navbar.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;
<span class="hljs-keyword">import</span> { useSession } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next-auth/react&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/link&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Navbar</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: session } = <span class="hljs-title function_">useSession</span>();

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      {session?.user?.role === &#x27;contractor&#x27; &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/contractor/dashboard&quot;</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      )}
      {session?.user?.role === &#x27;homeowner&#x27; &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/homeowner/assessments&quot;</span>&gt;</span>My Assessments<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
  );
}
</code></pre>
<h4 id="35-enforcing-rbac-in-backend-google-cloud-functions"><strong>3.5. Enforcing RBAC in Backend Google Cloud Functions</strong></h4>
<p>When a Cloud Function is invoked (e.g., for lead matching or AR processing), it must verify that the operation is authorized. For functions called directly from the frontend, <strong>Callable Functions</strong> are the recommended approach as they automatically verify the Firebase Auth ID token.</p>
<ul>
<li><strong>Protecting a Callable Cloud Function:</strong></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// functions/src/leads.ts</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> functions <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-functions&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> admin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-admin&quot;</span>;

<span class="hljs-comment">/**
 * A callable function for a contractor to express interest in a lead.
 * The context object automatically contains verified auth information.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> expressInterestInLead = functions.<span class="hljs-property">https</span>.<span class="hljs-title function_">onCall</span>(<span class="hljs-keyword">async</span> (data, context) =&gt; {
  <span class="hljs-comment">// 1. Check for authentication</span>
  <span class="hljs-keyword">if</span> (!context.<span class="hljs-property">auth</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> functions.<span class="hljs-property">https</span>.<span class="hljs-title class_">HttpsError</span>(
      <span class="hljs-string">&quot;unauthenticated&quot;</span>,
      <span class="hljs-string">&quot;The function must be called while authenticated.&quot;</span>
    );
  }

  <span class="hljs-comment">// 2. Check for correct role using the custom claim from the token</span>
  <span class="hljs-keyword">const</span> userRole = context.<span class="hljs-property">auth</span>.<span class="hljs-property">token</span>.<span class="hljs-property">role</span>;
  <span class="hljs-keyword">if</span> (userRole !== <span class="hljs-string">&quot;contractor&quot;</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> functions.<span class="hljs-property">https</span>.<span class="hljs-title class_">HttpsError</span>(
      <span class="hljs-string">&quot;permission-denied&quot;</span>,
      <span class="hljs-string">&quot;Only contractors can express interest in a lead.&quot;</span>
    );
  }

  <span class="hljs-keyword">const</span> contractorId = context.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>;
  <span class="hljs-keyword">const</span> { leadId } = data;

  <span class="hljs-keyword">if</span> (!leadId) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> functions.<span class="hljs-property">https</span>.<span class="hljs-title class_">HttpsError</span>(
      <span class="hljs-string">&quot;invalid-argument&quot;</span>,
      <span class="hljs-string">&quot;The function must be called with a &#x27;leadId&#x27;.&quot;</span>
    );
  }

  <span class="hljs-comment">// 3. Proceed with business logic</span>
  <span class="hljs-comment">// (e.g., update Firestore to link contractor to the lead)</span>
  functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Contractor <span class="hljs-subst">${contractorId}</span> is interested in lead <span class="hljs-subst">${leadId}</span>`</span>);
  <span class="hljs-comment">// ...database logic...</span>

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Interest registered successfully.&quot;</span> };
});
</code></pre>
<p>This multi-layered RBAC strategy ensures that user permissions are defined centrally, propagated securely, and enforced at every boundary of the system, providing a robust security posture for the HOMEase AI platform.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t3_auth_and_rbac_design&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Authentication and Role-Based Access Control (RBAC)&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Full-Stack Engineer with Security Focus&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="senior-nextjs-engineer-specialist">Senior Next.js Engineer Specialist</h3>
<p>Here is the detailed technical plan for the HOMEase AI Next.js frontend architecture and its deployment to Google Cloud Run, adhering to the project constraints and requirements.</p>
<hr>
<h3 id="part-2-nextjs-15-frontend-architecture--cloud-run-deployment"><strong>Part 2: Next.js 15 Frontend Architecture &amp; Cloud Run Deployment</strong></h3>
<p>This section details the architecture of the user-facing Next.js application and the robust deployment strategy on Google Cloud Run, which replaces Vercel as the hosting platform.</p>
<h4 id="21-nextjs-15-application-architecture"><strong>2.1. Next.js 15 Application Architecture</strong></h4>
<p>The frontend will be a single, monolithic Next.js 15 application serving both homeowners and contractors. The architecture prioritizes performance, security, and maintainability by leveraging the App Router and a &quot;Server-First&quot; component model.</p>
<p><strong>Core Principles:</strong></p>
<ul>
<li><strong>Server-First with App Router:</strong> We will use React Server Components (RSCs) by default for all components. This minimizes the client-side JavaScript bundle size, leading to faster initial page loads and improved SEOcritical for reaching a less tech-savvy demographic and for organic user acquisition.</li>
<li><strong>Progressive Enhancement:</strong> Client Components (<code>'use client'</code>) will be used deliberately and sparingly, only for UI that requires interactivity, browser APIs, or state management (e.g., forms, AR uploaders, real-time chat). This ensures the core content is always accessible, even on slower networks or devices.</li>
<li><strong>Type Safety:</strong> The entire codebase will use TypeScript to enforce type safety, reduce runtime errors, and improve developer experience. Zod will be used for schema validation at the API boundary.</li>
</ul>
<p><strong>Proposed Directory Structure:</strong></p>
<p>A logical, feature-based directory structure will be used to keep the codebase organized and scalable.</p>
<pre><code class="language-plaintext">/src
 /app/                               # Next.js App Router
    /api/                           # Backend API Routes (run on Cloud Run)
       /leads/                     # Handles lead creation, updates
       /ar-assessments/            # Handles AR data upload trigger
       /webhooks/                  # For Stripe, etc.
   
    /(marketing)/                   # Route group for public-facing pages
       page.tsx                    # Landing page (Server Component)
       /about/
   
    /(auth)/                        # Route group for authentication
       /login/
       /signup/
   
    /(dashboard)/                   # Protected routes with shared layout
       /homeowner/                 # Homeowner-specific dashboard
          /assessments/[id]/      # View a specific AR assessment (Server Component)
          page.tsx                # Main dashboard (Server Component)
      
       /contractor/                # Contractor-specific dashboard
           /leads/                 # View available leads (Server Component)
           page.tsx                # Performance dashboard (Server Component)
   
    layout.tsx                      # Root layout (provides Auth context)
    global-error.tsx                # Global error boundary

 /components/                        # Reusable React components
    /ui/                            # Primitive components from Shadcn/UI (Button, Card, Input)
    /features/                      # Business-logic components
        /ar/                        # AR Uploader, Visualization viewer (Client Components)
        /auth/                      # SignInForm, SignUpForm (Client Components)
        /leads/                     # LeadCard, LeadDetails (Server Components)

 /lib/                               # Core logic, helpers, SDK initializations
    /firebase/
       admin.ts                    # Server-side Firebase Admin SDK init
       client.ts                   # Client-side Firebase SDK init
    /auth.ts                        # NextAuth.js v5 configuration
    /stripe.ts                      # Stripe SDK initialization
    /validators/                    # Zod schemas for API inputs

 /providers/                         # Client-side context providers
    SessionProvider.tsx             # Wraps app with NextAuth session context

 /types/                             # Global TypeScript definitions
</code></pre>
<p><strong>Component Strategy: RSC vs. Client Components</strong></p>
<ul>
<li>
<p><strong>Server Components (Default):</strong></p>
<ul>
<li><strong>Data-Display Pages:</strong> <code>contractor/leads</code>, <code>homeowner/assessments/[id]</code>. These pages will fetch data directly from Firestore on the server using the Firebase Admin SDK. This is highly efficient as it avoids client-server request waterfalls.</li>
<li><strong>Static Pages:</strong> <code>/about</code>, <code>/pricing</code>. Content is rendered entirely on the server.</li>
<li><strong>Compositional UI:</strong> <code>LeadCard</code>, <code>Header</code>, <code>Footer</code>. These components receive data as props and do not require client-side state.</li>
</ul>
</li>
<li>
<p><strong>Client Components (<code>'use client'</code>):</strong></p>
<ul>
<li><strong>Interactive Forms:</strong> <code>SignInForm</code>, <code>LeadSubmissionForm</code>. Require <code>useState</code> for input management and <code>onSubmit</code> event handlers.</li>
<li><strong>AR Uploader:</strong> Requires access to browser APIs (File API, Camera) and state to track upload progress.</li>
<li><strong>Real-time Components:</strong> A <code>ChatWindow</code> component that uses <code>useEffect</code> to subscribe to Firestore's real-time listeners for new messages.</li>
<li><strong>Shadcn/UI Wrappers:</strong> Any component from Shadcn/UI that requires interactivity (e.g., <code>DropdownMenu</code>, <code>Dialog</code>, <code>Tabs</code>) must be a Client Component.</li>
</ul>
</li>
</ul>
<h4 id="22-deployment-to-google-cloud-run"><strong>2.2. Deployment to Google Cloud Run</strong></h4>
<p>The Next.js application will be containerized with Docker and deployed as a serverless service on Google Cloud Run. This provides auto-scaling, pay-per-use billing, and seamless integration with other GCP services.</p>
<p><strong>Optimized <code>next.config.mjs</code> for Cloud Run:</strong></p>
<p>To create a minimal production server, the Next.js config will enable the standalone output mode.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// next.config.mjs</span>
<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import(&#x27;next&#x27;).NextConfig</span>} */</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-comment">// Enables the standalone output, which creates a smaller deployment footprint</span>
  <span class="hljs-comment">// by copying only necessary files and node_modules into the .next/standalone folder.</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">&#x27;standalone&#x27;</span>,
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-comment">// Recommended for serverless environments to optimize cold starts</span>
    <span class="hljs-attr">serverComponentsExternalPackages</span>: [<span class="hljs-string">&#x27;@google-cloud/firestore&#x27;</span>],
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p><strong>Optimized Multi-Stage <code>Dockerfile</code>:</strong></p>
<p>This Dockerfile creates a small, secure, and efficient production image.</p>
<pre><code class="language-dockerfile"><span class="hljs-comment"># Stage 1: Builder - Install dependencies and build the application</span>
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">20</span>-slim AS builder
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>

<span class="hljs-comment"># Install dependencies</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> package*.json ./</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> npm ci</span>

<span class="hljs-comment"># Copy source code</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span>

<span class="hljs-comment"># Set build-time environment variables if needed (e.g., from Cloud Build)</span>
<span class="hljs-comment"># ARG NEXT_PUBLIC_FIREBASE_API_KEY</span>
<span class="hljs-comment"># ENV NEXT_PUBLIC_FIREBASE_API_KEY=$NEXT_PUBLIC_FIREBASE_API_KEY</span>

<span class="hljs-comment"># Build the Next.js application</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> npm run build</span>

<span class="hljs-comment"># ---</span>

<span class="hljs-comment"># Stage 2: Runner - Create the final, lean production image</span>
<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">20</span>-alpine AS runner
<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span>

<span class="hljs-comment"># Create a non-root user for security</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> addgroup --system --gid 1001 nodejs</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> adduser --system --uid 1001 nextjs</span>

<span class="hljs-comment"># Copy the standalone output from the builder stage</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder --<span class="hljs-built_in">chown</span>=nextjs:nodejs /app/.next/standalone ./</span>
<span class="hljs-comment"># Copy the static assets</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder --<span class="hljs-built_in">chown</span>=nextjs:nodejs /app/public ./public</span>

<span class="hljs-comment"># Set the user to the non-root user</span>
<span class="hljs-keyword">USER</span> nextjs

<span class="hljs-comment"># Expose the port the app will run on</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">3000</span>

<span class="hljs-comment"># Set the default port for Next.js</span>
<span class="hljs-keyword">ENV</span> PORT <span class="hljs-number">3000</span>

<span class="hljs-comment"># Start the Next.js server</span>
<span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;server.js&quot;</span>]</span>
</code></pre>
<h4 id="23-environment-variable-and-secret-management"><strong>2.3. Environment Variable and Secret Management</strong></h4>
<p>A robust and secure strategy for managing configuration is essential.</p>
<ul>
<li><strong>Google Secret Manager:</strong> All sensitive values will be stored here. This is the single source of truth for secrets.
<ul>
<li><code>NEXTAUTH_SECRET</code>: Session encryption key.</li>
<li><code>STRIPE_SECRET_KEY</code>: Stripe API secret key.</li>
<li><code>GOOGLE_GENAI_API_KEY</code>: Google Gemini API key.</li>
<li><code>FIREBASE_SERVICE_ACCOUNT_JSON</code>: Service account key for server-side Firebase Admin access.</li>
</ul>
</li>
<li><strong>Cloud Run Environment Variables:</strong> Only non-sensitive, public configuration will be set here.
<ul>
<li><code>NEXT_PUBLIC_FIREBASE_API_KEY</code>: The public Firebase SDK key.</li>
<li><code>NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</code>: The public Stripe key.</li>
<li><code>NEXTAUTH_URL</code>: The canonical URL of the deployed application.</li>
</ul>
</li>
</ul>
<p><strong>Setup Script (<code>setup_secrets.sh</code>)</strong></p>
<p>This script can be run by a lead developer or a CI/CD pipeline to provision secrets in GCP. It assumes the <code>gcloud</code> CLI is authenticated and configured.</p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># Exit on error</span>
<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># --- Configuration ---</span>
PROJECT_ID=<span class="hljs-string">&quot;your-gcp-project-id&quot;</span> <span class="hljs-comment"># CHANGE THIS</span>
REGION=<span class="hljs-string">&quot;us-central1&quot;</span> <span class="hljs-comment"># CHANGE THIS</span>
SERVICE_NAME=<span class="hljs-string">&quot;homease-ai-frontend&quot;</span>

<span class="hljs-comment"># Set the project for all subsequent gcloud commands</span>
gcloud config <span class="hljs-built_in">set</span> project <span class="hljs-variable">$PROJECT_ID</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--- Enabling required Google Cloud APIs ---&quot;</span>
gcloud services <span class="hljs-built_in">enable</span> secretmanager.googleapis.com
gcloud services <span class="hljs-built_in">enable</span> run.googleapis.com

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--- Creating secrets in Secret Manager (if they don&#x27;t exist) ---&quot;</span>

<span class="hljs-comment"># Function to create or update a secret</span>
<span class="hljs-function"><span class="hljs-title">create_secret</span></span>() {
  <span class="hljs-built_in">local</span> SECRET_NAME=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> SECRET_VALUE=<span class="hljs-variable">$2</span>
  <span class="hljs-keyword">if</span> gcloud secrets describe <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_NAME</span>&quot;</span> &amp;&gt;/dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Secret &#x27;<span class="hljs-variable">$SECRET_NAME</span>&#x27; already exists. Adding new version.&quot;</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_VALUE</span>&quot;</span> | gcloud secrets versions add <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_NAME</span>&quot;</span> --data-file=-
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Creating secret &#x27;<span class="hljs-variable">$SECRET_NAME</span>&#x27;.&quot;</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_VALUE</span>&quot;</span> | gcloud secrets create <span class="hljs-string">&quot;<span class="hljs-variable">$SECRET_NAME</span>&quot;</span> --data-file=- --replication-policy=<span class="hljs-string">&quot;automatic&quot;</span>
  <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># --- IMPORTANT ---</span>
<span class="hljs-comment"># In a real environment, you would source these values from a secure location,</span>
<span class="hljs-comment"># like a local .env file (added to .gitignore) or CI/CD secret variables.</span>
<span class="hljs-comment"># For this example, we use placeholder values.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Example:</span>
<span class="hljs-comment"># read -sp &quot;Enter your NEXTAUTH_SECRET: &quot; NEXTAUTH_SECRET_VAL</span>
<span class="hljs-comment"># create_secret &quot;NEXTAUTH_SECRET&quot; &quot;$NEXTAUTH_SECRET_VAL&quot;</span>

create_secret <span class="hljs-string">&quot;NEXTAUTH_SECRET&quot;</span> <span class="hljs-string">&quot;REPLACE_WITH_REAL_SECRET_USING_openssl_rand_base64_32&quot;</span>
create_secret <span class="hljs-string">&quot;STRIPE_SECRET_KEY&quot;</span> <span class="hljs-string">&quot;sk_test_REPLACE_WITH_REAL_SECRET&quot;</span>
create_secret <span class="hljs-string">&quot;GOOGLE_GENAI_API_KEY&quot;</span> <span class="hljs-string">&quot;REPLACE_WITH_REAL_GEMINI_KEY&quot;</span>

<span class="hljs-comment"># For the service account JSON, it&#x27;s better to pipe the file directly</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Creating Firebase Service Account secret from file &#x27;firebase-service-account.json&#x27;...&quot;</span>
<span class="hljs-comment"># Ensure you have the service account JSON file locally for this step</span>
create_secret <span class="hljs-string">&quot;FIREBASE_SERVICE_ACCOUNT_JSON&quot;</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(cat ./path/to/your/firebase-service-account.json)</span>&quot;</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--- Secrets created successfully ---&quot;</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--- Granting Cloud Run service access to secrets ---&quot;</span>
<span class="hljs-comment"># Get the service account used by Cloud Run</span>
<span class="hljs-comment"># Note: This command assumes the default service account. If you create a dedicated one, use that email instead.</span>
CLOUD_RUN_SA_EMAIL=<span class="hljs-string">&quot;<span class="hljs-subst">$(gcloud projects get-iam-policy $PROJECT_ID --flatten=<span class="hljs-string">&quot;bindings[].members&quot;</span> --format=&#x27;table(bindings.members)</span>&#x27; --filter=&quot;</span>bindings.role:roles/run.invoker<span class="hljs-string">&quot; | grep &quot;</span>compute-system.iam.gserviceaccount.com<span class="hljs-string">&quot; | head -n 1)&quot;</span> <span class="hljs-comment"># This is a bit complex, better to use the project number based default SA</span>
PROJECT_NUMBER=$(gcloud projects describe <span class="hljs-variable">$PROJECT_ID</span> --format=<span class="hljs-string">&#x27;value(projectNumber)&#x27;</span>)
CLOUD_RUN_SA_EMAIL=<span class="hljs-string">&quot;<span class="hljs-variable">${PROJECT_NUMBER}</span>-compute@developer.gserviceaccount.com&quot;</span>


<span class="hljs-comment"># Grant the &#x27;Secret Manager Secret Accessor&#x27; role to the Cloud Run service account for each secret</span>
gcloud secrets add-iam-policy-binding <span class="hljs-string">&quot;NEXTAUTH_SECRET&quot;</span> --member=<span class="hljs-string">&quot;serviceAccount:<span class="hljs-variable">${CLOUD_RUN_SA_EMAIL}</span>&quot;</span> --role=<span class="hljs-string">&quot;roles/secretmanager.secretAccessor&quot;</span> --quiet
gcloud secrets add-iam-policy-binding <span class="hljs-string">&quot;STRIPE_SECRET_KEY&quot;</span> --member=<span class="hljs-string">&quot;serviceAccount:<span class="hljs-variable">${CLOUD_RUN_SA_EMAIL}</span>&quot;</span> --role=<span class="hljs-string">&quot;roles/secretmanager.secretAccessor&quot;</span> --quiet
gcloud secrets add-iam-policy-binding <span class="hljs-string">&quot;GOOGLE_GENAI_API_KEY&quot;</span> --member=<span class="hljs-string">&quot;serviceAccount:<span class="hljs-variable">${CLOUD_RUN_SA_EMAIL}</span>&quot;</span> --role=<span class="hljs-string">&quot;roles/secretmanager.secretAccessor&quot;</span> --quiet
gcloud secrets add-iam-policy-binding <span class="hljs-string">&quot;FIREBASE_SERVICE_ACCOUNT_JSON&quot;</span> --member=<span class="hljs-string">&quot;serviceAccount:<span class="hljs-variable">${CLOUD_RUN_SA_EMAIL}</span>&quot;</span> --role=<span class="hljs-string">&quot;roles/secretmanager.secretAccessor&quot;</span> --quiet

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--- Permissions granted. You can now deploy your Cloud Run service. ---&quot;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Use the following flags in your &#x27;gcloud run deploy&#x27; command:&quot;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest&quot;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--set-secrets=STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest&quot;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--set-secrets=GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest&quot;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;--set-secrets=FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest&quot;</span>
</code></pre>
<p><strong>Deployment Command Example (for <code>cloudbuild.yaml</code>):</strong></p>
<p>This command builds the container, pushes it to Artifact Registry, and deploys it to Cloud Run, securely mounting the secrets.</p>
<pre><code class="language-yaml"><span class="hljs-comment"># In your cloudbuild.yaml file</span>
<span class="hljs-attr">steps:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;gcr.io/cloud-builders/docker&#x27;</span>
  <span class="hljs-attr">args:</span> [<span class="hljs-string">&#x27;build&#x27;</span>, <span class="hljs-string">&#x27;-t&#x27;</span>, <span class="hljs-string">&#x27;${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>]
  
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;gcr.io/cloud-builders/docker&#x27;</span>
  <span class="hljs-attr">args:</span> [<span class="hljs-string">&#x27;push&#x27;</span>, <span class="hljs-string">&#x27;${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}&#x27;</span>]
  
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;gcr.io/google.com/cloudsdktool/cloud-sdk&#x27;</span>
  <span class="hljs-attr">entrypoint:</span> <span class="hljs-string">gcloud</span>
  <span class="hljs-attr">args:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;run&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;deploy&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;${_SERVICE_NAME}&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--region=${_REGION}&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--platform=managed&#x27;</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--allow-unauthenticated&#x27;</span> <span class="hljs-comment"># Or configure IAM for authenticated access</span>
    <span class="hljs-comment"># Mount secrets as environment variables</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest,STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest,GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest,FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest&#x27;</span>
    <span class="hljs-comment"># Set non-sensitive environment variables</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;--update-env-vars=NEXTAUTH_URL=https://${_SERVICE_NAME}-your-unique-hash-${_REGION}.a.run.app&#x27;</span>
</code></pre>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t6_nextjs_on_gcp_architecture&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan Next.js Frontend Architecture and Cloud Run Deployment&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Next.js Engineer&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="security-architect-specialist">Security Architect Specialist</h3>
<p>Here is the detailed technical architecture plan for Security, Compliance, and Contractor Vetting for the HOMEase AI platform.</p>
<hr>
<h3 id="7-security-compliance-and-vetting-1"><strong>7. Security, Compliance, and Vetting</strong></h3>
<p>A robust security and compliance posture is paramount for building trust with both homeowners and contractors, especially given the sensitive nature of the data involved. This section outlines a multi-layered strategy encompassing application security, data privacy, regulatory compliance, and a rigorous contractor quality assurance process.</p>
<h4 id="71-comprehensive-application-security"><strong>7.1. Comprehensive Application Security</strong></h4>
<p>Security is integrated at every layer of the platform, from the frontend to the database.</p>
<p><strong>7.1.1. Network and Transport Layer Security</strong>
All communication between clients (web browser, mobile app) and HOMEase AI servers will be encrypted using Transport Layer Security (TLS) 1.3. HTTPS will be strictly enforced across all domains and subdomains via configurations in the Google Cloud Load Balancer, which will terminate SSL/TLS before routing traffic to the Next.js application running on Cloud Run.</p>
<p><strong>7.1.2. Content Security Policy (CSP)</strong>
To mitigate Cross-Site Scripting (XSS) and other code injection vulnerabilities, a strict Content Security Policy (CSP) will be implemented. This is configured as a response header in the Next.js middleware.</p>
<ul>
<li><strong>File:</strong> <code>middleware.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/server&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">request: NextRequest</span>) {
  <span class="hljs-keyword">const</span> nonce = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(crypto.<span class="hljs-title function_">randomUUID</span>()).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>);
  <span class="hljs-keyword">const</span> cspHeader = <span class="hljs-string">`
    default-src &#x27;self&#x27;;
    script-src &#x27;self&#x27; &#x27;nonce-<span class="hljs-subst">${nonce}</span>&#x27; &#x27;strict-dynamic&#x27; https: http:;
    style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;;
    img-src &#x27;self&#x27; data: https://firebasestorage.googleapis.com https://*.googleusercontent.com;
    connect-src &#x27;self&#x27; https://*.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com wss://firestore.googleapis.com https://api.stripe.com https://api.fal.ai;
    font-src &#x27;self&#x27; https://fonts.gstatic.com;
    frame-src &#x27;self&#x27; https://js.stripe.com;
    object-src &#x27;none&#x27;;
    base-uri &#x27;self&#x27;;
    form-action &#x27;self&#x27;;
    frame-ancestors &#x27;none&#x27;;
    block-all-mixed-content;
    upgrade-insecure-requests;
  `</span>;

  <span class="hljs-keyword">const</span> requestHeaders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>(request.<span class="hljs-property">headers</span>);
  requestHeaders.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;x-nonce&#x27;</span>, nonce);
  requestHeaders.<span class="hljs-title function_">set</span>(
    <span class="hljs-string">&#x27;Content-Security-Policy&#x27;</span>,
    cspHeader.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s{2,}/g</span>, <span class="hljs-string">&#x27; &#x27;</span>).<span class="hljs-title function_">trim</span>()
  );

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>({
    <span class="hljs-attr">headers</span>: requestHeaders,
    <span class="hljs-attr">request</span>: {
      <span class="hljs-attr">headers</span>: requestHeaders,
    },
  });
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">matcher</span>: [
    {
      <span class="hljs-attr">source</span>: <span class="hljs-string">&#x27;/((?!api|_next/static|_next/image|favicon.ico).*)&#x27;</span>,
      <span class="hljs-attr">missing</span>: [
        { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;header&#x27;</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;next-router-prefetch&#x27;</span> },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;header&#x27;</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;purpose&#x27;</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;prefetch&#x27;</span> },
      ],
    },
  ],
};
</code></pre>
<p><strong>7.1.3. Input Validation with Zod</strong>
All data entering the system, whether through Next.js API Routes or Google Cloud Functions, will be rigorously validated using Zod. This prevents data corruption, NoSQL injection, and other payload-based attacks by ensuring every piece of data conforms to a predefined schema.</p>
<ul>
<li><strong>Example: Lead Creation Schema</strong> (<code>/lib/schemas/lead.ts</code>)</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;zod&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createLeadSchema = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">urgency</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">&#x27;low&#x27;</span>, <span class="hljs-string">&#x27;medium&#x27;</span>, <span class="hljs-string">&#x27;high&#x27;</span>]),
  <span class="hljs-attr">budgetRange</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;Budget range is required.&quot;</span>),
  <span class="hljs-attr">description</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">20</span>, <span class="hljs-string">&quot;Please provide more details.&quot;</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">2000</span>),
  <span class="hljs-attr">arAssessmentId</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(), <span class="hljs-comment">// Can be linked later</span>
  <span class="hljs-attr">homeownerAddress</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">street</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">state</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">zip</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">regex</span>(<span class="hljs-regexp">/^\d{5}$/</span>, <span class="hljs-string">&quot;Invalid ZIP code&quot;</span>),
  }),
});
</code></pre>
<ul>
<li><strong>Usage in an API Route</strong> (<code>/app/api/leads/route.ts</code>)</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/auth&quot;</span>;
<span class="hljs-keyword">import</span> { createLeadSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/schemas/lead&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">auth</span>();
  <span class="hljs-keyword">if</span> (session?.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> !== <span class="hljs-string">&#x27;homeowner&#x27;</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Forbidden&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">403</span> });
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">const</span> validatedData = createLeadSchema.<span class="hljs-title function_">parse</span>(body);

    <span class="hljs-comment">// ... proceed with validatedData to create the lead in Firestore ...</span>

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">leadId</span>: <span class="hljs-string">&quot;...&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">201</span> });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> z.<span class="hljs-property">ZodError</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">errors</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">400</span> });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }
}
</code></pre>
<h4 id="72-data-privacy-and-compliance-framework"><strong>7.2. Data Privacy and Compliance Framework</strong></h4>
<p>We operate on the principles of Privacy by Design and Data Minimization, ensuring compliance with regulations like CCPA and adopting a 'HIPAA-lite' mindset for sensitive information.</p>
<p><strong>7.2.1. Adherence to CCPA (California Consumer Privacy Act)</strong>
The platform will provide users with the rights guaranteed under CCPA:</p>
<ul>
<li><strong>Right to Know:</strong> All user-specific data (profile information, leads, projects) is accessible to the user through their respective dashboard.</li>
<li><strong>Right to Delete:</strong> A user can initiate an account deletion request from their profile settings. This triggers a secure <code>onUserDelete</code> Cloud Function that performs a &quot;soft delete&quot; by anonymizing PII in historical records (e.g., <code>leads</code>, <code>projects</code>) to preserve data integrity for analytics, and performs a &quot;hard delete&quot; of the user's document in the <code>users</code> collection and their associated documents in Firebase Storage.</li>
<li><strong>Right to Opt-Out:</strong> HOMEase AI does not sell personal information. Our privacy policy will clearly state how data is usedsolely for the purpose of matching homeowners with contractors.</li>
</ul>
<p><strong>7.2.2. 'HIPAA-lite' Approach for Sensitive Data</strong>
While HOMEase AI is not a &quot;Covered Entity&quot; under HIPAA, we recognize that information about home accessibility needs can imply sensitive health information. We therefore adopt best practices for handling this data:</p>
<ul>
<li><strong>Data Minimization:</strong> We will never ask for specific medical conditions or diagnoses. The AR assessment focuses on physical barriers and functional needs (e.g., &quot;difficulty navigating stairs,&quot; &quot;need for grab bars&quot;), not the underlying medical reason.</li>
<li><strong>Strict Access Control:</strong> As defined in the RBAC and Firestore Rules sections, access to lead details is strictly limited to the homeowner, the contractors they are matched with, and authorized admin personnel for support purposes.</li>
<li><strong>Clear Consent:</strong> The user must provide explicit consent before their AR assessment and lead details are shared with any contractors.</li>
</ul>
<p><strong>7.2.3. Data Encryption</strong></p>
<ul>
<li><strong>At Rest:</strong> All data stored in Google Firestore and Google Cloud Storage is automatically encrypted at rest using AES-256, managed by Google Cloud.</li>
<li><strong>In Transit:</strong> All data is encrypted in transit using TLS 1.3, as described above.</li>
</ul>
<p><strong>7.2.4. Auditing and Access Logging</strong>
To ensure accountability and detect unauthorized access, a two-tiered auditing strategy will be implemented:</p>
<ol>
<li><strong>Platform-Level Auditing:</strong> Google Cloud Audit Logs will be enabled for all services (Firestore, Cloud Functions, Cloud Storage). This automatically logs all API calls, including administrative actions and system-level data access.</li>
<li><strong>Application-Level Auditing:</strong> For highly sensitive actions within the application (e.g., an admin viewing a user's PII or a contractor purchasing a lead), a dedicated <code>audit_logs</code> collection will be used in Firestore. A server-side function will write a new document for each event, capturing who performed the action, what action was taken, on which resource, and when.</li>
</ol>
<h4 id="73-contractor-vetting-and-quality-assurance"><strong>7.3. Contractor Vetting and Quality Assurance</strong></h4>
<p>The platform's reputation hinges on the quality and trustworthiness of its contractors. A rigorous, multi-stage vetting process is a cornerstone of our value proposition.</p>
<p><strong>7.3.1. Vetting Process Overview</strong></p>
<ol>
<li><strong>Initial Signup:</strong> A contractor signs up and creates a profile. Their <code>vettingStatus</code> in the <code>users</code> collection is set to <code>'pending'</code>. Their profile is not public or eligible to receive leads.</li>
<li><strong>Document Submission:</strong> The contractor is guided through a secure portal to upload required documentation:
<ul>
<li>Proof of General Liability Insurance</li>
<li>State/Local Business License</li>
<li>Relevant Certifications (e.g., CAPS designation)</li>
</ul>
</li>
<li><strong>Third-Party Background Check:</strong> The contractor must consent to and pass a background check initiated through an integrated third-party service (e.g., Checkr).</li>
<li><strong>Admin Review:</strong> An internal administrator is notified of the completed application. The admin verifies the submitted documents, checks the license against state databases, and reviews the background check results.</li>
<li><strong>Approval/Rejection:</strong> The administrator updates the contractor's status in the admin dashboard.
<ul>
<li><strong>Approved:</strong> The <code>vettingStatus</code> is set to <code>'approved'</code>, and boolean flags like <code>insuranceVerified</code> are set to <code>true</code>. The contractor's profile becomes active, and they are now eligible for lead matching.</li>
<li><strong>Rejected:</strong> The <code>vettingStatus</code> is set to <code>'rejected'</code>, and the contractor is notified with a reason.</li>
</ul>
</li>
</ol>
<p><strong>7.3.2. Technical Implementation of Vetting</strong>
The contractor vetting process is managed through the <code>contractorProfile</code> object within the <code>users</code> collection, as defined in the Data Modeling section. The <code>vettingStatus</code> field (<code>pending</code>, <code>approved</code>, <code>rejected</code>, <code>resubmit_required</code>) acts as the state machine for this workflow. An admin-only dashboard provides the UI for our internal team to review and manage these states.</p>
<p><strong>7.3.3. Secure Document Handling</strong>
Contractor documents are sensitive and handled with utmost care.</p>
<ul>
<li>
<p><strong>Storage:</strong> Documents are uploaded directly from the client to a dedicated, locked-down Google Cloud Storage bucket.</p>
</li>
<li>
<p><strong>Path Naming Convention:</strong> Documents are stored using a non-guessable path structure to prevent enumeration attacks: <code>gs://[BUCKET_NAME]/contractor-vetting-docs/{userId}/{documentId}_{fileName}</code>.</p>
</li>
<li>
<p><strong>Storage Security Rules:</strong> Access is strictly controlled via Firebase Storage Security Rules, ensuring only the uploading contractor and authorized administrators can access the files.</p>
</li>
<li>
<p><strong>File:</strong> <code>storage.rules</code></p>
</li>
</ul>
<pre><code class="language-javascript">rules_version = <span class="hljs-string">&#x27;2&#x27;</span>;

service firebase.<span class="hljs-property">storage</span> {
  match /b/{bucket}/o {
    
    <span class="hljs-comment">// Public user profile pictures</span>
    match /profile-pictures/{userId}/{allPaths=**} {
      allow read;
      allow <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == userId;
    }

    <span class="hljs-comment">// Secure contractor vetting documents</span>
    match /contractor-vetting-docs/{userId}/{allPaths=**} {
      <span class="hljs-comment">// The user can upload their own documents.</span>
      <span class="hljs-comment">// An admin can read/write to manage the documents.</span>
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == userId || 
                          <span class="hljs-title function_">get</span>(<span class="hljs-regexp">/databases/</span>$(database)/documents/users/$(request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span>)).<span class="hljs-property">data</span>.<span class="hljs-property">role</span> == <span class="hljs-string">&#x27;admin&#x27;</span>;
    }

    <span class="hljs-comment">// AR assessment data for homeowners</span>
    match /ar-assessments/{userId}/{allPaths=**} {
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> request.<span class="hljs-property">auth</span>.<span class="hljs-property">uid</span> == userId;
    }

    <span class="hljs-comment">// Deny all other access by default</span>
    match /{allPaths=**} {
      allow read, <span class="hljs-attr">write</span>: <span class="hljs-keyword">if</span> <span class="hljs-literal">false</span>;
    }
  }
}
</code></pre>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t9_security_and_compliance&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Develop Security, Compliance, and Contractor Vetting Plan&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Security Architect&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="aiml-integration-specialist-specialist">AI/ML Integration Specialist Specialist</h3>
<p>Here is the detailed technical plan for the AR Assessment and AI Processing workflow.</p>
<hr>
<h3 id="4-ar-assessment-and-ai-processing-workflow"><strong>4. AR Assessment and AI Processing Workflow</strong></h3>
<p>This section details the end-to-end asynchronous workflow for the platform's core value proposition: the AR-based home assessment. The architecture is designed to provide a seamless user experience by offloading all heavy processing to a scalable, event-driven backend, ensuring the user's device remains responsive.</p>
<p>The primary goal is to take raw AR data captured by a homeowner, process it through a sophisticated AI pipeline, and return actionable insights and visualizations without blocking the user interface.</p>
<h4 id="41-workflow-overview"><strong>4.1. Workflow Overview</strong></h4>
<p>The process is broken down into four distinct stages, moving from the client to the backend and back to the client via real-time updates.</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant C as Homeowner's App (Next.js)
    participant S3 as Google Cloud Storage
    participant API as Next.js API Route
    participant PS as Pub/Sub Topic&lt;br&gt;(ar-assessment-created)
    participant GCF as Cloud Function&lt;br&gt;(arProcessing)
    participant FS as Firestore
    participant AI as AI Services&lt;br&gt;(Gemini &amp; Fal.ai)

    C-&gt;&gt;FS: 1. Create initial document&lt;br&gt;`ar-assessments/{id}`&lt;br&gt;status: 'uploading'
    C-&gt;&gt;S3: 2. Upload AR data (images, measurements)
    S3--&gt;&gt;C: Upload complete
    C-&gt;&gt;API: 3. POST /api/assessments/process&lt;br&gt;Payload: { assessmentId }
    API-&gt;&gt;FS: Update document&lt;br&gt;status: 'processing'
    API-&gt;&gt;PS: 4. Publish message&lt;br&gt;Payload: { assessmentId, userId }
    PS--&gt;&gt;API: Message acknowledged
    API--&gt;&gt;C: 202 Accepted
    Note right of C: UI shows &quot;Analyzing...&quot;

    PS--&gt;&gt;GCF: 5. Trigger function with message
    GCF-&gt;&gt;S3: 6. Download AR data from Storage
    GCF-&gt;&gt;AI: 7. Send data for analysis &amp; visualization
    AI--&gt;&gt;GCF: Return results (hazards, recommendations, image URL)
    GCF-&gt;&gt;FS: 8. Update document with results&lt;br&gt;status: 'complete'

    FS--&gt;&gt;C: 9. Real-time listener fires with updated data
    Note right of C: UI displays full assessment report
</code></pre>
<hr>
<h4 id="42-step-by-step-implementation-details"><strong>4.2. Step-by-Step Implementation Details</strong></h4>
<h5 id="step-1--2-client-side-data-capture-and-upload"><strong>Step 1 &amp; 2: Client-Side Data Capture and Upload</strong></h5>
<ol>
<li>
<p><strong>Data Capture:</strong> The Next.js application will guide the homeowner through capturing the necessary data using their device's camera. This will involve taking specific, well-lit photos of key areas (e.g., doorways, showers, stairways). If the user's device supports LiDAR (e.g., modern iPhones), the app can leverage WebXR or a native wrapper to capture precise measurements, which will be stored as a JSON object.</p>
</li>
<li>
<p><strong>Initial Firestore Document:</strong> Before starting the upload, the client generates a unique ID for the assessment. It then creates a new document in the <code>ar-assessments</code> collection with a default state.</p>
<ul>
<li><strong>Collection:</strong> <code>ar-assessments</code></li>
<li><strong>Document ID:</strong> Auto-generated (e.g., <code>asmt_123xyz</code>)</li>
<li><strong>Initial Data:</strong><pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auth.currentUser.uid&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uploading&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;createdAt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;serverTimestamp()&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;storageRefs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;results&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">null</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>Secure Upload to Cloud Storage:</strong> The client uses the Firebase SDK for JavaScript (<code>@firebase/storage</code>) to upload the captured files (images, JSON data) directly to a secure, user-specific path in Google Cloud Storage.</p>
<ul>
<li><strong>Storage Path:</strong> <code>ar-assessments/{userId}/{assessmentId}/raw_image_01.jpg</code></li>
<li>The <code>storage.rules</code> will be configured to only allow authenticated users to write to their own <code>{userId}</code> path, preventing unauthorized uploads.</li>
</ul>
</li>
</ol>
<h5 id="step-3--4-triggering-the-asynchronous-workflow"><strong>Step 3 &amp; 4: Triggering the Asynchronous Workflow</strong></h5>
<ol>
<li>
<p><strong>API Route Invocation:</strong> Once all files are successfully uploaded, the client updates the Firestore document status to <code>'pending'</code> and makes a <code>POST</code> request to a dedicated Next.js API route.</p>
<ul>
<li><strong>Endpoint:</strong> <code>/api/assessments/process</code></li>
<li><strong>Method:</strong> <code>POST</code></li>
<li><strong>Body:</strong> <code>{ &quot;assessmentId&quot;: &quot;asmt_123xyz&quot; }</code></li>
</ul>
</li>
<li>
<p><strong>API Route Logic:</strong> This API route is intentionally lightweight. Its sole responsibilities are:</p>
<ul>
<li><strong>Authentication &amp; Authorization:</strong> Verify the user is signed in and owns the <code>assessmentId</code> they submitted.</li>
<li><strong>Update Status:</strong> Immediately update the Firestore document status to <code>'processing'</code>. This provides instant feedback to the user that their request has been received and is being worked on.</li>
<li><strong>Publish to Pub/Sub:</strong> Use the Google Cloud Pub/Sub Node.js client library to publish a message to the designated topic.</li>
</ul>
<pre><code class="language-typescript"><span class="hljs-comment">// /pages/api/assessments/process.ts (simplified)</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PubSub</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@google-cloud/pubsub&#x27;</span>;
<span class="hljs-keyword">import</span> { firestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/firebase-admin&#x27;</span>; <span class="hljs-comment">// Admin SDK instance</span>
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;zod&#x27;</span>;

<span class="hljs-keyword">const</span> pubSubClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PubSub</span>();
<span class="hljs-keyword">const</span> topicName = <span class="hljs-string">&#x27;ar-assessment-created&#x27;</span>;

<span class="hljs-keyword">const</span> schema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">assessmentId</span>: z.<span class="hljs-title function_">string</span>() });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-comment">// 1. Auth check (NextAuth session)</span>
  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSession</span>({ req });
  <span class="hljs-keyword">if</span> (!session) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">end</span>();

  <span class="hljs-comment">// 2. Input validation</span>
  <span class="hljs-keyword">const</span> { assessmentId } = schema.<span class="hljs-title function_">parse</span>(req.<span class="hljs-property">body</span>);

  <span class="hljs-comment">// 3. Authorization check (user owns the assessment)</span>
  <span class="hljs-keyword">const</span> assessmentRef = firestore.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&#x27;ar-assessments&#x27;</span>).<span class="hljs-title function_">doc</span>(assessmentId);
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> assessmentRef.<span class="hljs-title function_">get</span>();
  <span class="hljs-keyword">if</span> (!doc.<span class="hljs-property">exists</span> || doc.<span class="hljs-title function_">data</span>().<span class="hljs-property">userId</span> !== session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">end</span>();
  }

  <span class="hljs-comment">// 4. Update status and publish message</span>
  <span class="hljs-keyword">await</span> assessmentRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;processing&#x27;</span> });
  <span class="hljs-keyword">const</span> message = { assessmentId, <span class="hljs-attr">userId</span>: session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> };
  <span class="hljs-keyword">await</span> pubSubClient.<span class="hljs-title function_">topic</span>(topicName).<span class="hljs-title function_">publishMessage</span>({ <span class="hljs-attr">json</span>: message });

  <span class="hljs-comment">// 5. Respond to client</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">202</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Processing started&#x27;</span> });
}
</code></pre>
</li>
</ol>
<h5 id="step-5---8-backend-ai-processing-with-a-cloud-function"><strong>Step 5 - 8: Backend AI Processing with a Cloud Function</strong></h5>
<p>A powerful, 2nd Generation Google Cloud Function will perform the heavy lifting. Gen 2 functions are built on Cloud Run, offering longer timeouts (up to 60 minutes), more memory, and better performance for intensive tasks.</p>
<ul>
<li><strong>Function Name:</strong> <code>arProcessing</code></li>
<li><strong>Trigger:</strong> Event-driven, from the <code>ar-assessment-created</code> Pub/Sub topic.</li>
<li><strong>Configuration:</strong>
<ul>
<li><strong>Memory:</strong> 2GiB (adjustable based on performance testing).</li>
<li><strong>Timeout:</strong> 5 minutes (adjustable).</li>
<li><strong>Service Account:</strong> A dedicated IAM service account with permissions for Firestore, Cloud Storage, and Secret Manager (to access AI API keys).</li>
</ul>
</li>
</ul>
<p><strong>Function Logic:</strong></p>
<pre><code class="language-typescript"><span class="hljs-comment">// index.ts for the Cloud Function</span>
<span class="hljs-keyword">import</span> { onMessagePublished } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase-functions/v2/pubsub&#x27;</span>;
<span class="hljs-keyword">import</span> { getStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase-admin/storage&#x27;</span>;
<span class="hljs-keyword">import</span> { getFirestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase-admin/firestore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GoogleGenerativeAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@google/generative-ai&#x27;</span>;
<span class="hljs-comment">// import { FalClient } from &#x27;@fal-ai/serverless-client&#x27;; // Example</span>

<span class="hljs-comment">// Initialize SDKs</span>
<span class="hljs-keyword">const</span> firestore = <span class="hljs-title function_">getFirestore</span>();
<span class="hljs-keyword">const</span> storage = <span class="hljs-title function_">getStorage</span>();
<span class="hljs-keyword">const</span> genAI = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoogleGenerativeAI</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">GEMINI_API_KEY</span>);
<span class="hljs-comment">// const fal = new FalClient({ key: process.env.FAL_AI_KEY });</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> arProcessing = <span class="hljs-title function_">onMessagePublished</span>(<span class="hljs-string">&#x27;ar-assessment-created&#x27;</span>, <span class="hljs-keyword">async</span> (event) =&gt; {
  <span class="hljs-keyword">const</span> { assessmentId, userId } = event.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-property">json</span>;
  <span class="hljs-keyword">const</span> assessmentRef = firestore.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&#x27;ar-assessments&#x27;</span>).<span class="hljs-title function_">doc</span>(assessmentId);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. Download images from Cloud Storage</span>
    <span class="hljs-keyword">const</span> bucket = storage.<span class="hljs-title function_">bucket</span>();
    <span class="hljs-keyword">const</span> [files] = <span class="hljs-keyword">await</span> bucket.<span class="hljs-title function_">getFiles</span>({ <span class="hljs-attr">prefix</span>: <span class="hljs-string">`ar-assessments/<span class="hljs-subst">${userId}</span>/<span class="hljs-subst">${assessmentId}</span>/`</span> });
    <span class="hljs-keyword">const</span> imageBuffers = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
      files.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> file.<span class="hljs-title function_">download</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> data[<span class="hljs-number">0</span>]))
    );

    <span class="hljs-comment">// 2. Prepare data for Gemini</span>
    <span class="hljs-keyword">const</span> model = genAI.<span class="hljs-title function_">getGenerativeModel</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">&#x27;gemini-1.5-pro-latest&#x27;</span> });
    <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`
      You are a Certified Aging-in-Place Specialist (CAPS). Analyze the following images of a home.
      Identify all potential accessibility hazards and safety risks for an older adult.
      For each hazard, provide a clear, actionable modification recommendation.
      Format your response as a JSON object with two keys: &quot;hazards&quot; and &quot;recommendations&quot;.
    `</span>;
    <span class="hljs-keyword">const</span> imageParts = imageBuffers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">buffer</span> =&gt;</span> ({
      <span class="hljs-attr">inlineData</span>: { <span class="hljs-attr">data</span>: buffer.<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>), <span class="hljs-attr">mimeType</span>: <span class="hljs-string">&#x27;image/jpeg&#x27;</span> },
    }));

    <span class="hljs-comment">// 3. Call Gemini API for analysis</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generateContent</span>([prompt, ...imageParts]);
    <span class="hljs-keyword">const</span> responseText = result.<span class="hljs-property">response</span>.<span class="hljs-title function_">text</span>();
    <span class="hljs-keyword">const</span> analysis = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(responseText); <span class="hljs-comment">// Contains hazards and recommendations</span>

    <span class="hljs-comment">// 4. Call Fal.ai for visualization (using the primary image)</span>
    <span class="hljs-comment">// const visualizationResult = await fal.run(&#x27;fal-ai/image-to-image&#x27;, {</span>
    <span class="hljs-comment">//   image_url: &#x27;URL_to_primary_image_in_storage&#x27;,</span>
    <span class="hljs-comment">//   prompt: `Add this modification: ${analysis.recommendations[0].details}`</span>
    <span class="hljs-comment">// });</span>
    <span class="hljs-comment">// const visualizationUrl = visualizationResult.images[0].url;</span>
    <span class="hljs-keyword">const</span> visualizationUrl = <span class="hljs-string">&quot;https://example.com/mock-visualization.jpg&quot;</span>; <span class="hljs-comment">// Placeholder</span>

    <span class="hljs-comment">// 5. Update Firestore with the complete results</span>
    <span class="hljs-keyword">await</span> assessmentRef.<span class="hljs-title function_">update</span>({
      <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;complete&#x27;</span>,
      <span class="hljs-string">&#x27;results.hazards&#x27;</span>: analysis.<span class="hljs-property">hazards</span>,
      <span class="hljs-string">&#x27;results.recommendations&#x27;</span>: analysis.<span class="hljs-property">recommendations</span>,
      <span class="hljs-string">&#x27;results.visualizationUrl&#x27;</span>: visualizationUrl,
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Successfully processed assessment <span class="hljs-subst">${assessmentId}</span>`</span>);

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to process assessment <span class="hljs-subst">${assessmentId}</span>`</span>, error);
    <span class="hljs-keyword">await</span> assessmentRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;failed&#x27;</span>, <span class="hljs-string">&#x27;results.error&#x27;</span>: error.<span class="hljs-property">message</span> });
  }
});
</code></pre>
<h5 id="step-9-real-time-ui-update"><strong>Step 9: Real-Time UI Update</strong></h5>
<p>The Next.js frontend will use a real-time listener from the Firebase SDK to watch for changes on the specific assessment document.</p>
<pre><code class="language-typescript"><span class="hljs-comment">// React component snippet</span>
<span class="hljs-keyword">import</span> { doc, onSnapshot } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;firebase/firestore&#x27;</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AssessmentStatus</span>(<span class="hljs-params">{ assessmentId }</span>) {
  <span class="hljs-keyword">const</span> [assessment, setAssessment] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> unsub = <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-title function_">doc</span>(firestore, <span class="hljs-string">&#x27;ar-assessments&#x27;</span>, assessmentId), <span class="hljs-function">(<span class="hljs-params">doc</span>) =&gt;</span> {
      <span class="hljs-title function_">setAssessment</span>(doc.<span class="hljs-title function_">data</span>());
    });
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsub</span>(); <span class="hljs-comment">// Cleanup listener on unmount</span>
  }, [assessmentId]);

  <span class="hljs-keyword">if</span> (!assessment) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (assessment.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;processing&#x27;</span>) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Analyzing your space...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (assessment.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;complete&#x27;</span>) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DisplayResults</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{assessment.results}</span> /&gt;</span></span>;
  <span class="hljs-keyword">if</span> (assessment.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;failed&#x27;</span>) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>An error occurred.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;

  <span class="hljs-comment">// ... other states</span>
}
</code></pre>
<p>This ensures that as soon as the Cloud Function completes its work and updates Firestore, the user's screen automatically transitions from a loading state to displaying the full, rich report without requiring a page refresh.</p>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t4_ar_assessment_and_ai_flow&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan AR Assessment and AI Processing Workflow&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AI/ML Integration Specialist&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="senior-backend-engineer-specialist">Senior Backend Engineer Specialist</h3>
<p>Here is the detailed technical plan for the lead generation and contractor matching workflow for the HOMEase AI platform.</p>
<hr>
<h3 id="5-lead-generation-and-contractor-matching-workflow"><strong>5. Lead Generation and Contractor Matching Workflow</strong></h3>
<p>This section details the asynchronous, event-driven workflow for handling new lead submissions and matching them with qualified contractors. This architecture is designed for scalability and responsiveness, ensuring the user receives immediate feedback while complex backend processing occurs independently.</p>
<p>The core principle is to decouple the initial lead submission from the computationally intensive matching process. The Next.js API provides a fast, synchronous response to the user, while Google Cloud Pub/Sub and Cloud Functions handle the heavy lifting asynchronously.</p>
<h4 id="51-workflow-sequence-diagram"><strong>5.1. Workflow Sequence Diagram</strong></h4>
<p>The following diagram illustrates the end-to-end process, from the homeowner's submission to the real-time updates on both homeowner and contractor dashboards.</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant Homeowner as Homeowner's App (Next.js)
    participant NextJsApi as Next.js API (/api/leads/create)
    participant Firestore
    participant PubSub as Google Cloud Pub/Sub
    participant CloudFunction as leadMatching Function
    participant Contractor as Contractor's App (Next.js)

    Homeowner-&gt;&gt;+NextJsApi: POST /api/leads/create (Lead Data)
    NextJsApi-&gt;&gt;NextJsApi: Validate Input (Zod) &amp; User Auth
    NextJsApi-&gt;&gt;+Firestore: Create Lead doc (status: 'new')
    Firestore--&gt;&gt;-NextJsApi: Return new leadId
    NextJsApi-&gt;&gt;+PubSub: Publish message to 'lead-created' topic (payload: { leadId })
    PubSub--&gt;&gt;-NextJsApi: Acknowledge message
    NextJsApi--&gt;&gt;-Homeowner: Respond 201 Created ({&quot;status&quot;: &quot;success&quot;, &quot;leadId&quot;: ...})

    Note right of Homeowner: Homeowner UI shows &quot;We've received your request!&quot;

    PubSub-&gt;&gt;+CloudFunction: Trigger leadMatching function with message
    CloudFunction-&gt;&gt;+Firestore: Update Lead doc (status: 'matching')
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update

    Note over Homeowner,Contractor: Real-time listener updates UI
    Homeowner-&gt;&gt;Firestore: onSnapshot(leadDoc)
    Firestore--&gt;&gt;Homeowner: Update UI (Status: &quot;Finding Contractors...&quot;)

    CloudFunction-&gt;&gt;+Firestore: Query 'users' for approved contractors in service area &amp; specialty
    Firestore--&gt;&gt;-CloudFunction: Return list of potential contractors
    CloudFunction-&gt;&gt;CloudFunction: Run matching algorithm (filter, sort by rating)
    CloudFunction-&gt;&gt;+Firestore: Update Lead doc (status: 'matched', matchedContractorIds: [...])
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update

    Note over Homeowner,Contractor: Real-time listener updates UI
    Homeowner-&gt;&gt;Firestore: onSnapshot(leadDoc)
    Firestore--&gt;&gt;Homeowner: Update UI (Status: &quot;Contractors Found!&quot;)
    Contractor-&gt;&gt;Firestore: onSnapshot(leadsQuery)
    Firestore--&gt;&gt;Contractor: New lead appears in dashboard
</code></pre>
<hr>
<h4 id="52-step-1-lead-submission-nextjs-api-route"><strong>5.2. Step 1: Lead Submission (Next.js API Route)</strong></h4>
<p>The homeowner initiates the process by submitting a form in the Next.js application. This triggers a <code>POST</code> request to a dedicated API Route handler.</p>
<ul>
<li><strong>File:</strong> <code>app/api/leads/create/route.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zod&quot;</span>;
<span class="hljs-keyword">import</span> { auth } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/auth&quot;</span>; <span class="hljs-comment">// From NextAuth.js</span>
<span class="hljs-keyword">import</span> { firestore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/firebase/admin&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PubSub</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@google-cloud/pubsub&quot;</span>;

<span class="hljs-comment">// Zod schema for validating the incoming request body</span>
<span class="hljs-keyword">const</span> createLeadSchema = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">urgency</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">&quot;low&quot;</span>, <span class="hljs-string">&quot;medium&quot;</span>, <span class="hljs-string">&quot;high&quot;</span>]),
  <span class="hljs-attr">budgetRange</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Budget range is required.&quot;</span>),
  <span class="hljs-attr">description</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">20</span>, <span class="hljs-string">&quot;Please provide a detailed description.&quot;</span>),
  <span class="hljs-attr">arAssessmentId</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(), <span class="hljs-comment">// Link to an existing AR assessment</span>
  <span class="hljs-comment">// Specialties required for the job, used for matching</span>
  <span class="hljs-attr">requiredSpecialties</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()).<span class="hljs-title function_">optional</span>(),
});

<span class="hljs-comment">// Initialize Pub/Sub client</span>
<span class="hljs-keyword">const</span> pubsub = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PubSub</span>({
  <span class="hljs-attr">projectId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GOOGLE_CLOUD_PROJECT_ID</span>,
});
<span class="hljs-keyword">const</span> topicName = <span class="hljs-string">&quot;lead-created&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. Authenticate and Authorize the user</span>
    <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">auth</span>();
    <span class="hljs-keyword">if</span> (session?.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> !== <span class="hljs-string">&quot;homeowner&quot;</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Forbidden&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">403</span> });
    }
    <span class="hljs-keyword">const</span> homeownerId = session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>;

    <span class="hljs-comment">// 2. Validate the request body</span>
    <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">const</span> validatedData = createLeadSchema.<span class="hljs-title function_">parse</span>(body);

    <span class="hljs-comment">// 3. Create the lead document in Firestore</span>
    <span class="hljs-keyword">const</span> leadsCollection = firestore.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;leads&quot;</span>);
    <span class="hljs-keyword">const</span> homeownerDoc = <span class="hljs-keyword">await</span> firestore.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;users&quot;</span>).<span class="hljs-title function_">doc</span>(homeownerId).<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">const</span> homeownerInfo = homeownerDoc.<span class="hljs-title function_">data</span>();

    <span class="hljs-keyword">const</span> newLead = {
      homeownerId,
      <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;new&quot;</span>, <span class="hljs-comment">// Initial status</span>
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
      <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
      ...validatedData,
      <span class="hljs-comment">// Denormalize homeowner info for efficient matching</span>
      <span class="hljs-attr">homeownerInfo</span>: {
        <span class="hljs-attr">displayName</span>: homeownerInfo?.<span class="hljs-property">displayName</span>,
        <span class="hljs-attr">city</span>: homeownerInfo?.<span class="hljs-property">address</span>?.<span class="hljs-property">city</span>,
        <span class="hljs-attr">state</span>: homeownerInfo?.<span class="hljs-property">address</span>?.<span class="hljs-property">state</span>,
        <span class="hljs-attr">zip</span>: homeownerInfo?.<span class="hljs-property">address</span>?.<span class="hljs-property">zip</span>,
      },
      <span class="hljs-attr">matchedContractorIds</span>: [],
    };

    <span class="hljs-keyword">const</span> leadRef = <span class="hljs-keyword">await</span> leadsCollection.<span class="hljs-title function_">add</span>(newLead);
    <span class="hljs-keyword">const</span> leadId = leadRef.<span class="hljs-property">id</span>;

    <span class="hljs-comment">// 4. Publish a message to Pub/Sub to trigger the matching function</span>
    <span class="hljs-keyword">const</span> messageBuffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ leadId, <span class="hljs-attr">requiredSpecialties</span>: validatedData.<span class="hljs-property">requiredSpecialties</span> }));
    <span class="hljs-keyword">await</span> pubsub.<span class="hljs-title function_">topic</span>(topicName).<span class="hljs-title function_">publishMessage</span>({ <span class="hljs-attr">data</span>: messageBuffer });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Published message for leadId: <span class="hljs-subst">${leadId}</span> to topic <span class="hljs-subst">${topicName}</span>`</span>);

    <span class="hljs-comment">// 5. Return a success response to the client immediately</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, leadId }, { <span class="hljs-attr">status</span>: <span class="hljs-number">201</span> });

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> z.<span class="hljs-property">ZodError</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">errors</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">400</span> });
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Error creating lead:&quot;</span>, error);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Internal Server Error&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }
}
</code></pre>
<hr>
<h4 id="53-step-2-asynchronous-matching-google-cloud-function"><strong>5.3. Step 2: Asynchronous Matching (Google Cloud Function)</strong></h4>
<p>This function listens for new messages on the <code>lead-created</code> Pub/Sub topic and performs the contractor matching logic.</p>
<ul>
<li><strong>File:</strong> <code>functions/src/leads.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> functions <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-functions&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> admin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-admin&quot;</span>;

<span class="hljs-comment">// Initialize Admin SDK if not already done</span>
<span class="hljs-keyword">if</span> (admin.<span class="hljs-property">apps</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
  admin.<span class="hljs-title function_">initializeApp</span>();
}
<span class="hljs-keyword">const</span> db = admin.<span class="hljs-title function_">firestore</span>();

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_MATCHES</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// Find up to 3 contractors per lead</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> onLeadCreated = functions.<span class="hljs-property">pubsub</span>
  .<span class="hljs-title function_">topic</span>(<span class="hljs-string">&quot;lead-created&quot;</span>)
  .<span class="hljs-title function_">onPublish</span>(<span class="hljs-keyword">async</span> (message) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. Decode the message payload</span>
      <span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(message.<span class="hljs-property">data</span>, <span class="hljs-string">&quot;base64&quot;</span>).<span class="hljs-title function_">toString</span>());
      <span class="hljs-keyword">const</span> { leadId, requiredSpecialties } = payload;

      <span class="hljs-keyword">if</span> (!leadId) {
        functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Message missing leadId&quot;</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }

      <span class="hljs-comment">// 2. Fetch the lead document and update its status</span>
      <span class="hljs-keyword">const</span> leadRef = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;leads&quot;</span>).<span class="hljs-title function_">doc</span>(leadId);
      <span class="hljs-keyword">const</span> leadSnapshot = <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">get</span>();
      <span class="hljs-keyword">if</span> (!leadSnapshot.<span class="hljs-property">exists</span>) {
        functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Lead with ID: <span class="hljs-subst">${leadId}</span> not found.`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;matching&quot;</span>, <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() });
      <span class="hljs-keyword">const</span> leadData = leadSnapshot.<span class="hljs-title function_">data</span>()!;

      <span class="hljs-comment">// 3. Find potential contractors based on service area</span>
      <span class="hljs-keyword">const</span> homeownerZip = leadData.<span class="hljs-property">homeownerInfo</span>.<span class="hljs-property">zip</span>;
      <span class="hljs-keyword">if</span> (!homeownerZip) {
        <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;failed&quot;</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Missing homeowner zip code.&quot;</span> });
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }

      <span class="hljs-keyword">const</span> contractorsQuery = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;users&quot;</span>)
        .<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;role&quot;</span>, <span class="hljs-string">&quot;==&quot;</span>, <span class="hljs-string">&quot;contractor&quot;</span>)
        .<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;contractorProfile.vettingStatus&quot;</span>, <span class="hljs-string">&quot;==&quot;</span>, <span class="hljs-string">&quot;approved&quot;</span>)
        .<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;contractorProfile.serviceAreaZips&quot;</span>, <span class="hljs-string">&quot;array-contains&quot;</span>, homeownerZip);

      <span class="hljs-keyword">const</span> contractorsSnapshot = <span class="hljs-keyword">await</span> contractorsQuery.<span class="hljs-title function_">get</span>();
      <span class="hljs-keyword">if</span> (contractorsSnapshot.<span class="hljs-property">empty</span>) {
        functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`No contractors found for zip code: <span class="hljs-subst">${homeownerZip}</span>`</span>);
        <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;no_match_found&quot;</span>, <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() });
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }

      <span class="hljs-comment">// 4. Filter and rank the contractors in-memory</span>
      <span class="hljs-keyword">let</span> matchedContractors = contractorsSnapshot.<span class="hljs-property">docs</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: doc.<span class="hljs-property">id</span>, ...doc.<span class="hljs-title function_">data</span>() }));

      <span class="hljs-comment">// Filter by specialty if provided</span>
      <span class="hljs-keyword">if</span> (requiredSpecialties &amp;&amp; requiredSpecialties.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        matchedContractors = matchedContractors.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span>
          requiredSpecialties.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">spec</span> =&gt;</span> c.<span class="hljs-property">contractorProfile</span>?.<span class="hljs-property">specialties</span>?.<span class="hljs-title function_">includes</span>(spec))
        );
      }

      <span class="hljs-comment">// Sort by rating (descending) and then by number of reviews</span>
      matchedContractors.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> ratingA = a.<span class="hljs-property">contractorProfile</span>?.<span class="hljs-property">averageRating</span> || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> ratingB = b.<span class="hljs-property">contractorProfile</span>?.<span class="hljs-property">averageRating</span> || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (ratingB !== ratingA) {
          <span class="hljs-keyword">return</span> ratingB - ratingA;
        }
        <span class="hljs-keyword">const</span> reviewsA = a.<span class="hljs-property">contractorProfile</span>?.<span class="hljs-property">reviewCount</span> || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> reviewsB = b.<span class="hljs-property">contractorProfile</span>?.<span class="hljs-property">reviewCount</span> || <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> reviewsB - reviewsA;
      });

      <span class="hljs-comment">// 5. Select the top N contractors and update the lead</span>
      <span class="hljs-keyword">const</span> finalMatchedIds = matchedContractors.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">MAX_MATCHES</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span>);

      <span class="hljs-keyword">if</span> (finalMatchedIds.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;no_match_found&quot;</span>, <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">await</span> leadRef.<span class="hljs-title function_">update</span>({
          <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;matched&quot;</span>,
          <span class="hljs-attr">matchedContractorIds</span>: finalMatchedIds,
          <span class="hljs-attr">updatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
        });
      }

      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Successfully matched <span class="hljs-subst">${finalMatchedIds.length}</span> contractors to lead <span class="hljs-subst">${leadId}</span>.`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    } <span class="hljs-keyword">catch</span> (error) {
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error processing lead matching for message: <span class="hljs-subst">${message.data}</span>`</span>, error);
      <span class="hljs-comment">// Optionally, update the lead with a &#x27;failed&#x27; status</span>
      <span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(message.<span class="hljs-property">data</span>, <span class="hljs-string">&quot;base64&quot;</span>).<span class="hljs-title function_">toString</span>());
      <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">leadId</span>) {
        <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;leads&quot;</span>).<span class="hljs-title function_">doc</span>(payload.<span class="hljs-property">leadId</span>).<span class="hljs-title function_">update</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;failed&quot;</span> });
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  });
</code></pre>
<hr>
<h4 id="54-step-3-real-time-frontend-updates-react-hooks-with-firestore"><strong>5.4. Step 3: Real-Time Frontend Updates (React Hooks with Firestore)</strong></h4>
<p>The frontend uses Firestore's <code>onSnapshot</code> listeners to subscribe to data changes in real-time. This is encapsulated within custom React hooks for clean, reusable logic.</p>
<p><strong>For the Homeowner:</strong> A hook to listen to a single lead's status.</p>
<ul>
<li><strong>File:</strong> <code>hooks/useLeadStatus.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;
<span class="hljs-keyword">import</span> { doc, onSnapshot } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { db } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/firebase/client&quot;</span>; <span class="hljs-comment">// Client-side Firestore instance</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLeadStatus</span>(<span class="hljs-params">leadId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> [lead, setLead] = useState&lt;<span class="hljs-built_in">any</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!leadId) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> leadRef = <span class="hljs-title function_">doc</span>(db, <span class="hljs-string">&quot;leads&quot;</span>, leadId);
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">onSnapshot</span>(
      leadRef,
      <span class="hljs-function">(<span class="hljs-params">docSnapshot</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (docSnapshot.<span class="hljs-title function_">exists</span>()) {
          <span class="hljs-title function_">setLead</span>({ <span class="hljs-attr">id</span>: docSnapshot.<span class="hljs-property">id</span>, ...docSnapshot.<span class="hljs-title function_">data</span>() });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">setError</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Lead not found.&quot;</span>));
          <span class="hljs-title function_">setLead</span>(<span class="hljs-literal">null</span>);
        }
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      },
      <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Error listening to lead status:&quot;</span>, err);
        <span class="hljs-title function_">setError</span>(err);
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      }
    );

    <span class="hljs-comment">// Cleanup subscription on unmount</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsubscribe</span>();
  }, [leadId]);

  <span class="hljs-keyword">return</span> { lead, loading, error };
}
</code></pre>
<p><strong>For the Contractor:</strong> A hook to listen for new leads they have been matched with.</p>
<ul>
<li><strong>File:</strong> <code>hooks/useContractorLeads.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;
<span class="hljs-keyword">import</span> { collection, query, where, onSnapshot, orderBy } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { db } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/lib/firebase/client&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useContractorLeads</span>(<span class="hljs-params">contractorId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> [leads, setLeads] = useState&lt;<span class="hljs-built_in">any</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!contractorId) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> leadsRef = <span class="hljs-title function_">collection</span>(db, <span class="hljs-string">&quot;leads&quot;</span>);
    <span class="hljs-keyword">const</span> q = <span class="hljs-title function_">query</span>(
      leadsRef,
      <span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;matchedContractorIds&quot;</span>, <span class="hljs-string">&quot;array-contains&quot;</span>, contractorId),
      <span class="hljs-title function_">orderBy</span>(<span class="hljs-string">&quot;createdAt&quot;</span>, <span class="hljs-string">&quot;desc&quot;</span>)
    );

    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">onSnapshot</span>(q, <span class="hljs-function">(<span class="hljs-params">querySnapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> newLeads = querySnapshot.<span class="hljs-property">docs</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: doc.<span class="hljs-property">id</span>, ...doc.<span class="hljs-title function_">data</span>() }));
      <span class="hljs-title function_">setLeads</span>(newLeads);
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    });

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsubscribe</span>();
  }, [contractorId]);

  <span class="hljs-keyword">return</span> { leads, loading };
}
</code></pre>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t5_lead_matching_workflow&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Lead Generation and Contractor Matching Workflow&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Senior Backend Engineer&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="devops-engineer-specialist">DevOps Engineer Specialist</h3>
<p>Here is the detailed CI/CD and DevOps plan for the HOMEase AI platform using GitHub Actions and Google Cloud Platform.</p>
<hr>
<h3 id="part-8-cicd-and-devops-plan"><strong>Part 8: CI/CD and DevOps Plan</strong></h3>
<p>This plan outlines the automated processes for continuous integration and continuous deployment (CI/CD) using GitHub Actions. The strategy is designed for security, reliability, and clear separation of development, staging, and production environments, all hosted on Google Cloud Platform.</p>
<h4 id="81-cicd-strategy-overview"><strong>8.1. CI/CD Strategy Overview</strong></h4>
<ul>
<li><strong>Source Control:</strong> A single monorepo on GitHub containing the Next.js application, Google Cloud Functions, and Firebase configuration.</li>
<li><strong>Branching Strategy:</strong> A GitFlow-like model will be used to manage deployments:
<ul>
<li><code>feature/*</code>: Developers work on new features in these branches.</li>
<li><code>develop</code>: The integration branch. All feature branches are merged here. A merge to <code>develop</code> triggers a deployment to the <strong>Development</strong> environment.</li>
<li><code>staging</code>: A release candidate branch. Merging <code>develop</code> into <code>staging</code> triggers a deployment to the <strong>Staging</strong> environment for UAT and final validation.</li>
<li><code>main</code>: The production branch. Merging <code>staging</code> into <code>main</code> (after approval) triggers a deployment to the <strong>Production</strong> environment.</li>
</ul>
</li>
<li><strong>Environment Isolation:</strong> Each environment (Dev, Staging, Prod) will correspond to a separate Google Cloud Project to ensure complete resource isolation (databases, functions, storage, secrets).
<ul>
<li>Development: <code>homease-ai-dev</code></li>
<li>Staging: <code>homease-ai-staging</code></li>
<li>Production: <code>homease-ai-prod</code></li>
</ul>
</li>
<li><strong>Authentication:</strong> GitHub Actions will authenticate with GCP using <strong>Workload Identity Federation (WIF)</strong>. This is a secure, keyless mechanism that grants GitHub Actions workflows short-lived access tokens, eliminating the need to store long-lived GCP service account keys as GitHub secrets.</li>
<li><strong>Workflow Triggers:</strong> Workflows will be triggered by pushes and pull requests to specific branches. <code>paths</code> filters will be used to ensure that only relevant workflows run (e.g., only run the backend deployment if files in the <code>/functions</code> directory are changed).</li>
</ul>
<h4 id="82-prerequisite-setup-gcp-and-github-configuration"><strong>8.2. Prerequisite Setup: GCP and GitHub Configuration</strong></h4>
<p>Before creating the workflows, the following one-time setup is required.</p>
<p><strong>Step 1: Set up Workload Identity Federation in GCP</strong></p>
<p><em>For each GCP project (<code>dev</code>, <code>staging</code>, <code>prod</code>):</em></p>
<ol>
<li><strong>Enable APIs:</strong><pre><code class="language-bash">gcloud services <span class="hljs-built_in">enable</span> iam.googleapis.com \
    iamcredentials.googleapis.com \
    cloudresourcemanager.googleapis.com \
    artifactregistry.googleapis.com \
    run.googleapis.com \
    secretmanager.googleapis.com
</code></pre>
</li>
<li><strong>Create a WIF Pool and Provider:</strong><pre><code class="language-bash"><span class="hljs-comment"># Replace &lt;PROJECT_ID&gt; with your GCP Project ID</span>
gcloud iam workload-identity-pools create <span class="hljs-string">&quot;github-pool&quot;</span> \
  --project=<span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --location=<span class="hljs-string">&quot;global&quot;</span> \
  --display-name=<span class="hljs-string">&quot;GitHub Actions Pool&quot;</span>

<span class="hljs-comment"># Get the full ID of the pool</span>
POOL_ID=$(gcloud iam workload-identity-pools describe <span class="hljs-string">&quot;github-pool&quot;</span> \
  --project=<span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> --location=<span class="hljs-string">&quot;global&quot;</span> --format=<span class="hljs-string">&quot;value(name)&quot;</span>)

<span class="hljs-comment"># Create the provider</span>
gcloud iam workload-identity-pools providers create-oidc <span class="hljs-string">&quot;github-provider&quot;</span> \
  --project=<span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --location=<span class="hljs-string">&quot;global&quot;</span> \
  --workload-identity-pool=<span class="hljs-string">&quot;github-pool&quot;</span> \
  --display-name=<span class="hljs-string">&quot;GitHub Actions Provider&quot;</span> \
  --issuer-uri=<span class="hljs-string">&quot;https://token.actions.githubusercontent.com&quot;</span> \
  --attribute-mapping=<span class="hljs-string">&quot;google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository&quot;</span>
</code></pre>
</li>
<li><strong>Create a dedicated Service Account (SA) for CI/CD:</strong><pre><code class="language-bash"><span class="hljs-comment"># This SA will be used by GitHub Actions to deploy resources</span>
gcloud iam service-accounts create <span class="hljs-string">&quot;github-actions-deployer&quot;</span> \
  --project=<span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --display-name=<span class="hljs-string">&quot;GitHub Actions Deployer SA&quot;</span>
</code></pre>
</li>
<li><strong>Grant the SA necessary IAM Roles:</strong><pre><code class="language-bash"><span class="hljs-comment"># Roles for deploying to Cloud Run and managing Artifact Registry</span>
gcloud projects add-iam-policy-binding <span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --member=<span class="hljs-string">&quot;serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/run.admin&quot;</span>
gcloud projects add-iam-policy-binding <span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --member=<span class="hljs-string">&quot;serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/artifactregistry.admin&quot;</span>
gcloud projects add-iam-policy-binding <span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --member=<span class="hljs-string">&quot;serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/iam.serviceAccountUser&quot;</span> <span class="hljs-comment"># Allows SA to act as the Cloud Run runtime SA</span>

<span class="hljs-comment"># Roles for deploying Firebase/Cloud Functions</span>
gcloud projects add-iam-policy-binding <span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --member=<span class="hljs-string">&quot;serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/cloudfunctions.admin&quot;</span>
gcloud projects add-iam-policy-binding <span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --member=<span class="hljs-string">&quot;serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/firebase.admin&quot;</span> <span class="hljs-comment"># For deploying Firestore rules, etc.</span>
</code></pre>
</li>
<li><strong>Allow GitHub Actions to impersonate the Service Account:</strong><pre><code class="language-bash"><span class="hljs-comment"># Replace &lt;OWNER&gt;/&lt;REPO&gt; with your GitHub repository details</span>
gcloud iam service-accounts add-iam-policy-binding <span class="hljs-string">&quot;github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com&quot;</span> \
  --project=<span class="hljs-string">&quot;&lt;PROJECT_ID&gt;&quot;</span> \
  --role=<span class="hljs-string">&quot;roles/iam.workloadIdentityUser&quot;</span> \
  --member=<span class="hljs-string">&quot;principalSet://iam.googleapis.com/<span class="hljs-variable">${POOL_ID}</span>/attribute.repository/&lt;OWNER&gt;/&lt;REPO&gt;&quot;</span>
</code></pre>
</li>
</ol>
<p><strong>Step 2: Configure GitHub Environments and Secrets</strong></p>
<ol>
<li>
<p>In your GitHub repository, go to <strong>Settings &gt; Environments</strong>.</p>
</li>
<li>
<p>Create three environments: <code>development</code>, <code>staging</code>, and <code>production</code>.</p>
</li>
<li>
<p>For <code>staging</code> and <code>production</code>, add <strong>Protection Rules</strong>, such as requiring an authorized reviewer to approve deployments.</p>
</li>
<li>
<p>Add the following <strong>Environment secrets</strong> to each environment, pointing to the corresponding GCP project values:</p>
<ul>
<li><code>GCP_PROJECT_ID</code>: e.g., <code>homease-ai-dev</code> for the <code>development</code> environment.</li>
<li><code>GCP_WORKLOAD_IDENTITY_PROVIDER</code>: The full path of the WIF provider (e.g., <code>projects/123456/locations/global/workloadIdentityPools/github-pool/providers/github-provider</code>).</li>
<li><code>GCP_SERVICE_ACCOUNT</code>: The email of the SA created above (e.g., <code>github-actions-deployer@homease-ai-dev.iam.gserviceaccount.com</code>).</li>
<li><code>GCP_REGION</code>: e.g., <code>us-central1</code>.</li>
</ul>
</li>
</ol>
<h4 id="83-workflow-1-pr-validation-pr-checkyml"><strong>8.3. Workflow 1: PR Validation (<code>pr-check.yml</code>)</strong></h4>
<p>This workflow runs on every pull request targeting the <code>develop</code> branch. It ensures code quality before merging.</p>
<p><strong>.github/workflows/pr-check.yml</strong></p>
<pre><code class="language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">PR</span> <span class="hljs-string">Validation</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">develop</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">validate:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Lint,</span> <span class="hljs-string">Type-Check</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">Repository</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">&#x27;20&#x27;</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">&#x27;npm&#x27;</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">ci</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">ESLint</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">lint</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">Compiler</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">type-check</span>

      <span class="hljs-comment"># - name: Run Unit &amp; Integration Tests</span>
      <span class="hljs-comment">#   run: npm run test # Uncomment when tests are added</span>
</code></pre>
<h4 id="84-workflow-2-frontend-deployment-to-cloud-run-deploy-frontendyml"><strong>8.4. Workflow 2: Frontend Deployment to Cloud Run (<code>deploy-frontend.yml</code>)</strong></h4>
<p>This workflow builds and deploys the Next.js application to Google Cloud Run. It is triggered on pushes to <code>develop</code>, <code>staging</code>, and <code>main</code>.</p>
<p><strong>.github/workflows/deploy-frontend.yml</strong></p>
<pre><code class="language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Frontend</span> <span class="hljs-string">to</span> <span class="hljs-string">Cloud</span> <span class="hljs-string">Run</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">develop</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">staging</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;src/**&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;public/**&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;next.config.mjs&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;package*.json&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;Dockerfile&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;.github/workflows/deploy-frontend.yml&#x27;</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-comment"># Determine environment based on branch name</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">${{</span> <span class="hljs-string">(github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/main&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">&#x27;production&#x27;</span><span class="hljs-string">)</span> <span class="hljs-string">||</span> <span class="hljs-string">(github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/staging&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">&#x27;staging&#x27;</span><span class="hljs-string">)</span> <span class="hljs-string">||</span> <span class="hljs-string">&#x27;development&#x27;</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">&#x27;read&#x27;</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">&#x27;write&#x27;</span> <span class="hljs-comment"># Required for OIDC authentication</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">Repository</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">Google</span> <span class="hljs-string">Cloud</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">&#x27;google-github-actions/auth@v2&#x27;</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Google</span> <span class="hljs-string">Cloud</span> <span class="hljs-string">SDK</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">&#x27;google-github-actions/setup-gcloud@v2&#x27;</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">Docker</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">gcloud</span> <span class="hljs-string">auth</span> <span class="hljs-string">configure-docker</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_REGION</span> <span class="hljs-string">}}-docker.pkg.dev</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">Push</span> <span class="hljs-string">Docker</span> <span class="hljs-string">Image</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">IMAGE_PATH:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_REGION</span> <span class="hljs-string">}}-docker.pkg.dev/${{</span> <span class="hljs-string">secrets.GCP_PROJECT_ID</span> <span class="hljs-string">}}/homease-ai/frontend:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          docker build -t $IMAGE_PATH .
          docker push $IMAGE_PATH
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Cloud</span> <span class="hljs-string">Run</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SERVICE_NAME:</span> <span class="hljs-string">homease-ai-frontend</span>
          <span class="hljs-attr">IMAGE_PATH:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_REGION</span> <span class="hljs-string">}}-docker.pkg.dev/${{</span> <span class="hljs-string">secrets.GCP_PROJECT_ID</span> <span class="hljs-string">}}/homease-ai/frontend:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_PATH }} \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --platform managed \
            --allow-unauthenticated \
            --set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest,STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest,GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest,FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest \
            --update-env-vars=NEXTAUTH_URL=https://$(gcloud run services describe ${{ env.SERVICE_NAME }} --platform managed --region ${{ secrets.GCP_REGION }} --project ${{ secrets.GCP_PROJECT_ID }} --format &#x27;value(status.url)&#x27; | sed &#x27;s|https://||&#x27;)
</span></code></pre>
<h4 id="85-workflow-3-backend-deployment-deploy-backendyml"><strong>8.5. Workflow 3: Backend Deployment (<code>deploy-backend.yml</code>)</strong></h4>
<p>This workflow deploys Google Cloud Functions and Firebase assets (Firestore rules, Storage rules). It uses the Firebase CLI for deployment.</p>
<p><strong>.github/workflows/deploy-backend.yml</strong></p>
<pre><code class="language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Backend</span> <span class="hljs-string">to</span> <span class="hljs-string">Firebase</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">GCP</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">develop</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">staging</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;functions/**&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;firestore.rules&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;storage.rules&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;.firebaserc&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;firebase.json&#x27;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;.github/workflows/deploy-backend.yml&#x27;</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">${{</span> <span class="hljs-string">(github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/main&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">&#x27;production&#x27;</span><span class="hljs-string">)</span> <span class="hljs-string">||</span> <span class="hljs-string">(github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;refs/heads/staging&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">&#x27;staging&#x27;</span><span class="hljs-string">)</span> <span class="hljs-string">||</span> <span class="hljs-string">&#x27;development&#x27;</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">permissions:</span>
      <span class="hljs-attr">contents:</span> <span class="hljs-string">&#x27;read&#x27;</span>
      <span class="hljs-attr">id-token:</span> <span class="hljs-string">&#x27;write&#x27;</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">Repository</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">&#x27;20&#x27;</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Firebase</span> <span class="hljs-string">CLI</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">firebase-tools</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Authenticate</span> <span class="hljs-string">to</span> <span class="hljs-string">Google</span> <span class="hljs-string">Cloud</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">&#x27;google-github-actions/auth@v2&#x27;</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">workload_identity_provider:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_WORKLOAD_IDENTITY_PROVIDER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">service_account:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GCP_SERVICE_ACCOUNT</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Function</span> <span class="hljs-string">Dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">ci</span>
        <span class="hljs-attr">working-directory:</span> <span class="hljs-string">./functions</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Firebase</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # The .firebaserc file maps the alias to the GCP Project ID.
          # The correct project is selected automatically based on the alias.
          firebase deploy --project ${{ secrets.GCP_PROJECT_ID }} --only functions,firestore,storage --force
</span></code></pre>
<h4 id="86-required-configuration-files"><strong>8.6. Required Configuration Files</strong></h4>
<p>For the backend deployment to work seamlessly, the following files must be present in the repository root.</p>
<p><strong>.firebaserc</strong>
This file maps a project alias to the actual GCP Project ID. The Firebase CLI uses this to target the correct environment.</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;projects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;development&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;homease-ai-dev&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;staging&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;homease-ai-staging&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;production&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;homease-ai-prod&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><em>Note: The workflow shown above uses the <code>GCP_PROJECT_ID</code> secret directly for simplicity and explicitness. The <code>.firebaserc</code> file provides a powerful alternative where you could pass an alias (e.g., <code>firebase deploy --project development</code>) instead.</em></p>
<p><strong>firebase.json</strong>
This file defines which assets to deploy.</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;functions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;functions&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;runtime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nodejs20&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;firestore&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;firestore.rules&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;indexes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;firestore.indexes.json&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;storage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;storage.rules&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t8_cicd_and_devops_plan&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Plan CI/CD Pipeline with GitHub Actions for GCP&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DevOps Engineer&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="backend-engineer-with-stripe-integration-experience-specialist">Backend Engineer with Stripe Integration Experience Specialist</h3>
<p>Here is the detailed technical plan for the payment and contractor onboarding system for the HOMEase AI platform.</p>
<hr>
<h3 id="7-payment-and-contractor-onboarding-system"><strong>7. Payment and Contractor Onboarding System</strong></h3>
<p>This section details the architecture for contractor onboarding, verification, and the pay-per-lead transaction system. The entire workflow is built on <strong>Stripe Connect</strong> for robust identity verification and <strong>Stripe Checkout</strong> for secure payments. The system is designed to be automated and scalable, using Google Cloud Functions to handle asynchronous events from Stripe via webhooks, ensuring the platform's data integrity.</p>
<h4 id="71-stripe-integration-strategy-stripe-connect-express"><strong>7.1. Stripe Integration Strategy: Stripe Connect Express</strong></h4>
<p>To balance rapid development with a professional, branded user experience, HOMEase will utilize <strong>Stripe Connect Express</strong>. This approach offers several key advantages:</p>
<ul>
<li><strong>Fast Go-to-Market:</strong> Stripe provides a pre-built, co-branded, and mobile-optimized onboarding UI, significantly reducing frontend development effort.</li>
<li><strong>Reduced Compliance Burden:</strong> Stripe handles the collection and verification of sensitive information (like bank details and tax IDs), helping HOMEase meet KYC (Know Your Customer) requirements.</li>
<li><strong>Platform Control:</strong> HOMEase remains the primary platform. Contractors interact with HOMEase for leads, and Stripe handles the financial verification and payout logistics in the background.</li>
<li><strong>Scalability:</strong> The Express model is designed to scale from a few contractors to thousands without requiring significant re-architecture.</li>
</ul>
<h4 id="72-contractor-onboarding-and-verification-flow"><strong>7.2. Contractor Onboarding and Verification Flow</strong></h4>
<p>The goal of this flow is to create a Stripe Connected Account for each contractor, link it to their HOMEase profile, and use Stripe's verification process as a key part of the platform's vetting protocol.</p>
<p><strong>Sequence Diagram:</strong></p>
<pre><code class="language-mermaid">sequenceDiagram
    participant ContractorApp as Contractor Dashboard (Next.js)
    participant NextJsApi as Next.js API Route
    participant CloudFunction as createStripeAccount Function
    participant Firestore
    participant Stripe

    ContractorApp-&gt;&gt;+NextJsApi: POST /api/contractor/onboarding/start
    NextJsApi-&gt;&gt;+CloudFunction: Invoke createStripeAccount (or call Stripe SDK directly)
    CloudFunction-&gt;&gt;+Stripe: stripe.accounts.create({ type: 'express', ... })
    Stripe--&gt;&gt;-CloudFunction: Return Stripe Account ID (acct_...)
    CloudFunction-&gt;&gt;+Firestore: Update user/{userId}: { contractorProfile.stripeAccountId: 'acct_...' }
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update
    CloudFunction-&gt;&gt;+Stripe: stripe.accountLinks.create({ account: 'acct_...', ... })
    Stripe--&gt;&gt;-CloudFunction: Return one-time onboarding URL
    CloudFunction--&gt;&gt;-NextJsApi: Return onboarding URL
    NextJsApi--&gt;&gt;-ContractorApp: Respond with { onboardingUrl: 'https://connect.stripe.com/...' }
    ContractorApp-&gt;&gt;Stripe: Redirect user to onboardingUrl

    Note right of Stripe: Contractor completes onboarding form on Stripe's site.

    Stripe-&gt;&gt;Stripe: Verifies information.
    Stripe--&gt;&gt;ContractorApp: Redirects user back to HOMEase (return_url)

    Note over Stripe, CloudFunction: Later, asynchronously...
    Stripe-&gt;&gt;CloudFunction: POST /stripe-webhook (Event: 'account.updated')
    CloudFunction-&gt;&gt;CloudFunction: Verify Stripe Signature
    CloudFunction-&gt;&gt;Firestore: Query for user with stripeAccountId
    CloudFunction-&gt;&gt;Firestore: Update user/{userId}: { contractorProfile.vettingStatus: 'approved' }
</code></pre>
<p><strong>Implementation Steps:</strong></p>
<ol>
<li>
<p><strong>Initiate Onboarding:</strong></p>
<ul>
<li>In the contractor dashboard, a user without a Stripe account sees a prompt: &quot;Complete Your Profile to Access Leads.&quot;</li>
<li>Clicking this button triggers a request to a Next.js API route: <code>POST /api/contractor/onboarding/start</code>.</li>
</ul>
</li>
<li>
<p><strong>Create Stripe Account &amp; Link (Server-Side):</strong></p>
<ul>
<li>The API route authenticates the user and invokes a Google Cloud Function (or uses the Admin SDK directly) to perform the following actions:
<ul>
<li><strong>Check for Existing Account:</strong> First, check if a <code>stripeAccountId</code> already exists for this user in Firestore to prevent duplicates.</li>
<li><strong>Create Stripe Express Account:</strong> Call <code>stripe.accounts.create</code> with the contractor's email and business type.</li>
<li><strong>Store Account ID:</strong> Save the returned Stripe account ID (e.g., <code>acct_123...</code>) to the contractor's profile in Firestore: <code>users/{userId}/contractorProfile/stripeAccountId</code>.</li>
<li><strong>Generate Onboarding Link:</strong> Call <code>stripe.accountLinks.create</code>, providing the <code>account</code> ID, a <code>refresh_url</code> (if the link expires), and a <code>return_url</code> (where the user lands after completion, e.g., <code>/contractor/dashboard?onboarding=complete</code>).</li>
<li><strong>Return URL:</strong> The API route responds to the frontend with the generated one-time URL.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Redirect and Return:</strong></p>
<ul>
<li>The Next.js frontend receives the URL and performs a <code>window.location.href</code> redirect, sending the contractor to the Stripe-hosted onboarding flow.</li>
<li>Upon completion, Stripe redirects the user back to the specified <code>return_url</code>. The UI can then show a &quot;Verification in progress&quot; message.</li>
</ul>
</li>
<li>
<p><strong>Asynchronous Verification (Webhook):</strong></p>
<ul>
<li>The verification is handled by the <code>stripe-webhook</code> Cloud Function, which listens for the <code>account.updated</code> event. This is detailed in section 7.4.</li>
<li>When the webhook receives confirmation that the account has <code>charges_enabled: true</code>, it updates the contractor's <code>vettingStatus</code> in Firestore from <code>pending_stripe</code> to <code>approved</code>. The contractor can now purchase leads.</li>
</ul>
</li>
</ol>
<hr>
<h4 id="73-pay-per-lead-transaction-flow"><strong>7.3. Pay-Per-Lead Transaction Flow</strong></h4>
<p>This flow enables an <code>approved</code> contractor to purchase a lead securely using Stripe Checkout.</p>
<p><strong>Sequence Diagram:</strong></p>
<pre><code class="language-mermaid">sequenceDiagram
    participant ContractorApp as Contractor Dashboard (Next.js)
    participant NextJsApi as Next.js API (/api/leads/purchase)
    participant Firestore
    participant Stripe

    ContractorApp-&gt;&gt;+NextJsApi: POST /api/leads/purchase ( { leadId: '...' } )
    NextJsApi-&gt;&gt;NextJsApi: Auth Check (isApprovedContractor?)
    NextJsApi-&gt;&gt;+Firestore: Get lead details (price, description)
    Firestore--&gt;&gt;-NextJsApi: Return lead data
    NextJsApi-&gt;&gt;+Stripe: stripe.checkout.sessions.create({ ..., metadata: { leadId, contractorId } })
    Stripe--&gt;&gt;-NextJsApi: Return Checkout Session ID (cs_...)
    NextJsApi--&gt;&gt;-ContractorApp: Respond with { sessionId: 'cs_...' }
    ContractorApp-&gt;&gt;Stripe: stripe.redirectToCheckout({ sessionId: 'cs_...' })

    Note right of Stripe: Contractor enters payment details on Stripe's secure page.

    Stripe--&gt;&gt;ContractorApp: Redirects to success_url on payment completion.

    Note over Stripe, CloudFunction: Asynchronously...
    Stripe-&gt;&gt;CloudFunction: POST /stripe-webhook (Event: 'checkout.session.completed')
    CloudFunction-&gt;&gt;CloudFunction: Verify Signature &amp; Parse Metadata
    CloudFunction-&gt;&gt;Firestore: Update lead/{leadId}: { purchasedBy: [..., contractorId] }
    CloudFunction-&gt;&gt;Firestore: Create transactions/{txId} document
</code></pre>
<p><strong>Implementation Steps:</strong></p>
<ol>
<li>
<p><strong>Initiate Purchase:</strong></p>
<ul>
<li>An approved contractor clicks a &quot;Purchase Lead for $XX&quot; button on a lead details page.</li>
<li>The frontend sends a <code>POST</code> request to <code>app/api/leads/purchase/route.ts</code> with the <code>leadId</code>.</li>
</ul>
</li>
<li>
<p><strong>Create Checkout Session (Server-Side):</strong></p>
<ul>
<li>The API route handler performs these critical steps:
<ul>
<li><strong>Authorization:</strong> Verifies the user is an authenticated contractor with a <code>vettingStatus</code> of <code>approved</code>.</li>
<li><strong>Fetch Lead Price:</strong> Retrieves the lead from Firestore to get the current price.</li>
<li><strong>Create Stripe Checkout Session:</strong> Calls <code>stripe.checkout.sessions.create</code> with the following parameters:
<ul>
<li><code>payment_method_types</code>: <code>['card']</code></li>
<li><code>line_items</code>: An array with the lead's name/description and price.</li>
<li><code>mode</code>: <code>'payment'</code></li>
<li><code>success_url</code>: <code>https://yourdomain.com/leads/{LEAD_ID}?purchase=success</code></li>
<li><code>cancel_url</code>: <code>https://yourdomain.com/leads/{LEAD_ID}?purchase=cancelled</code></li>
<li><strong><code>metadata</code></strong>: This is essential for reconciliation. Include <code>{ leadId: leadId, contractorId: session.user.id }</code>.</li>
</ul>
</li>
<li><strong>Return Session ID:</strong> The API responds with the <code>sessionId</code> from Stripe.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Redirect to Checkout:</strong></p>
<ul>
<li>The frontend uses the Stripe.js library and the received <code>sessionId</code> to redirect the contractor to the secure, Stripe-hosted payment page. <code>await stripe.redirectToCheckout({ sessionId });</code></li>
</ul>
</li>
<li>
<p><strong>Unlock Lead Access (Webhook):</strong></p>
<ul>
<li>The actual fulfillment (granting access to the lead's full details) is handled asynchronously by the <code>stripe-webhook</code> function upon receiving the <code>checkout.session.completed</code> event. This prevents users from gaining access if the payment ultimately fails.</li>
</ul>
</li>
</ol>
<hr>
<h4 id="74-secure-webhook-handler-google-cloud-function"><strong>7.4. Secure Webhook Handler (Google Cloud Function)</strong></h4>
<p>A single, robust Google Cloud Function with an HTTP trigger will serve as the endpoint for all Stripe events. This centralizes logic and security.</p>
<ul>
<li><strong>File:</strong> <code>functions/src/stripe.ts</code></li>
</ul>
<pre><code class="language-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> functions <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-functions&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> admin <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase-admin&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Stripe</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;stripe&quot;</span>;

<span class="hljs-comment">// Initialize Stripe with secret key from environment variables</span>
<span class="hljs-keyword">const</span> stripe = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stripe</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">STRIPE_SECRET_KEY</span>!, {
  <span class="hljs-attr">apiVersion</span>: <span class="hljs-string">&quot;2024-04-10&quot;</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-comment">// Initialize Firebase Admin SDK</span>
<span class="hljs-keyword">if</span> (admin.<span class="hljs-property">apps</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
  admin.<span class="hljs-title function_">initializeApp</span>();
}
<span class="hljs-keyword">const</span> db = admin.<span class="hljs-title function_">firestore</span>();

<span class="hljs-comment">/**
 * A single webhook handler for all Stripe events.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> stripeWebhookHandler = functions.<span class="hljs-property">https</span>.<span class="hljs-title function_">onRequest</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> sig = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;stripe-signature&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">const</span> webhookSecret = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRIPE_WEBHOOK_SECRET</span>!;

  <span class="hljs-keyword">let</span> <span class="hljs-attr">event</span>: <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Event</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. Verify the request is genuinely from Stripe</span>
    event = stripe.<span class="hljs-property">webhooks</span>.<span class="hljs-title function_">constructEvent</span>(req.<span class="hljs-property">rawBody</span>, sig, webhookSecret);
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: <span class="hljs-built_in">any</span>) {
    functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Stripe webhook signature verification failed.&quot;</span>, err.<span class="hljs-property">message</span>);
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">`Webhook Error: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. Handle the event based on its type</span>
  <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;account.updated&quot;</span>:
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleAccountUpdated</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Account</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;checkout.session.completed&quot;</span>:
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleCheckoutSessionCompleted</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Stripe</span>.<span class="hljs-property">Checkout</span>.<span class="hljs-property">Session</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ... handle other event types as needed</span>
    <span class="hljs-attr">default</span>:
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Unhandled event type <span class="hljs-subst">${event.<span class="hljs-keyword">type</span>}</span>`</span>);
  }

  <span class="hljs-comment">// 3. Acknowledge receipt of the event</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">received</span>: <span class="hljs-literal">true</span> });
});

<span class="hljs-comment">/**
 * Handles the &#x27;account.updated&#x27; event to update contractor vetting status.
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAccountUpdated</span>(<span class="hljs-params">account: Stripe.Account</span>) {
  <span class="hljs-keyword">const</span> stripeAccountId = account.<span class="hljs-property">id</span>;
  <span class="hljs-keyword">const</span> usersRef = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;users&quot;</span>);
  <span class="hljs-keyword">const</span> q = usersRef.<span class="hljs-title function_">where</span>(<span class="hljs-string">&quot;contractorProfile.stripeAccountId&quot;</span>, <span class="hljs-string">&quot;==&quot;</span>, stripeAccountId).<span class="hljs-title function_">limit</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">const</span> snapshot = <span class="hljs-keyword">await</span> q.<span class="hljs-title function_">get</span>();
  <span class="hljs-keyword">if</span> (snapshot.<span class="hljs-property">empty</span>) {
    functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`No user found for Stripe account ID: <span class="hljs-subst">${stripeAccountId}</span>`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> userDoc = snapshot.<span class="hljs-property">docs</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> newStatus = account.<span class="hljs-property">charges_enabled</span> ? <span class="hljs-string">&quot;approved&quot;</span> : <span class="hljs-string">&quot;action_required&quot;</span>;

  <span class="hljs-comment">// Update the user&#x27;s vetting status in Firestore</span>
  <span class="hljs-keyword">await</span> userDoc.<span class="hljs-property">ref</span>.<span class="hljs-title function_">update</span>({ <span class="hljs-string">&quot;contractorProfile.vettingStatus&quot;</span>: newStatus });
  functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Updated vetting status for user <span class="hljs-subst">${userDoc.id}</span> to &#x27;<span class="hljs-subst">${newStatus}</span>&#x27;.`</span>);
}

<span class="hljs-comment">/**
 * Handles &#x27;checkout.session.completed&#x27; to fulfill a lead purchase.
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCheckoutSessionCompleted</span>(<span class="hljs-params">session: Stripe.Checkout.Session</span>) {
  <span class="hljs-keyword">const</span> { leadId, contractorId } = session.<span class="hljs-property">metadata</span>!;

  <span class="hljs-keyword">if</span> (!leadId || !contractorId) {
    functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Missing metadata (leadId or contractorId) in checkout session.&quot;</span>, session.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> leadRef = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;leads&quot;</span>).<span class="hljs-title function_">doc</span>(leadId);
  <span class="hljs-keyword">const</span> transactionRef = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">&quot;transactions&quot;</span>).<span class="hljs-title function_">doc</span>(session.<span class="hljs-property">id</span>); <span class="hljs-comment">// Use session ID for idempotency</span>

  <span class="hljs-comment">// Use a transaction to ensure atomicity</span>
  <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">runTransaction</span>(<span class="hljs-keyword">async</span> (transaction) =&gt; {
    <span class="hljs-keyword">const</span> txDoc = <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">get</span>(transactionRef);
    <span class="hljs-keyword">if</span> (txDoc.<span class="hljs-property">exists</span>) {
      functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Transaction <span class="hljs-subst">${session.id}</span> already processed.`</span>);
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Idempotency check</span>
    }

    <span class="hljs-comment">// Grant access to the lead</span>
    transaction.<span class="hljs-title function_">update</span>(leadRef, {
      <span class="hljs-attr">purchasedBy</span>: admin.<span class="hljs-property">firestore</span>.<span class="hljs-property">FieldValue</span>.<span class="hljs-title function_">arrayUnion</span>(contractorId),
      <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;sold&quot;</span> <span class="hljs-comment">// Or a similar status</span>
    });

    <span class="hljs-comment">// Log the transaction for accounting</span>
    transaction.<span class="hljs-title function_">set</span>(transactionRef, {
      contractorId,
      leadId,
      <span class="hljs-attr">amount</span>: session.<span class="hljs-property">amount_total</span>,
      <span class="hljs-attr">currency</span>: session.<span class="hljs-property">currency</span>,
      <span class="hljs-attr">stripePaymentIntentId</span>: session.<span class="hljs-property">payment_intent</span>,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
    });
  });

  functions.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Fulfilled purchase of lead <span class="hljs-subst">${leadId}</span> for contractor <span class="hljs-subst">${contractorId}</span>.`</span>);
}
</code></pre>
<h4 id="75-firestore-data-model-updates"><strong>7.5. Firestore Data Model Updates</strong></h4>
<p>To support this system, the following fields will be added to the Firestore data models:</p>
<ul>
<li>
<p><strong><code>users</code> collection (for contractors):</strong></p>
<ul>
<li><code>contractorProfile</code> (map):
<ul>
<li><code>stripeAccountId</code> (string, e.g., &quot;acct_...&quot;)</li>
<li><code>vettingStatus</code> (string, e.g., &quot;pending_stripe&quot;, &quot;action_required&quot;, &quot;approved&quot;, &quot;rejected&quot;)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>leads</code> collection:</strong></p>
<ul>
<li><code>price</code> (number): The cost of the lead in cents.</li>
<li><code>purchasedBy</code> (array of strings): A list of <code>userId</code>s of contractors who have purchased this lead.</li>
<li><code>status</code> (string): Updated to &quot;sold&quot; or similar once purchased.</li>
</ul>
</li>
<li>
<p><strong><code>transactions</code> collection (New):</strong></p>
<ul>
<li><em>Document ID</em>: Stripe Checkout Session ID (<code>cs_...</code>) or Payment Intent ID (<code>pi_...</code>) for idempotency.</li>
<li><code>contractorId</code> (string)</li>
<li><code>leadId</code> (string)</li>
<li><code>amount</code> (number)</li>
<li><code>currency</code> (string)</li>
<li><code>status</code> (string, e.g., &quot;succeeded&quot;)</li>
<li><code>createdAt</code> (timestamp)</li>
</ul>
</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;t7_payments_and_onboarding&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Design Payment and Contractor Onboarding System&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;expertise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Backend Engineer with Stripe Integration Experience&quot;</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 id="results-integrator">Results Integrator</h3>
<p>Here is a solid, detailed technical architecture plan for the HOMEase AI platform, synthesized from the provided documentation and designed for execution by a development team.</p>
<h3 id="executive-summary-1"><strong>Executive Summary</strong></h3>
<p>This document presents the comprehensive technical architecture for the HOMEase AI platform, a lead generation service connecting homeowners with aging-in-place (AIP) contractors. The architecture is designed to be scalable, secure, and cost-efficient, directly supporting the business's strategic pivot to a pure-play lead generation model.</p>
<p>The platform is built exclusively on the Google Cloud Platform (GCP) ecosystem, leveraging a serverless, event-driven model to achieve rapid development cycles and operational efficiency. The core components include a Next.js 15 frontend hosted on <strong>Google Cloud Run</strong> (explicitly excluding Vercel), a suite of backend services using <strong>Google Cloud Functions</strong>, and a unified data layer with <strong>Firebase Firestore, Authentication, and Storage</strong>.</p>
<p>Key architectural features include:</p>
<ul>
<li><strong>Asynchronous Workflows:</strong> Core processes like AR assessment analysis and contractor matching are handled asynchronously using Google Cloud Pub/Sub, ensuring a responsive user experience.</li>
<li><strong>Role-Based Access Control (RBAC):</strong> A robust security model using Firebase Custom Claims and NextAuth.js enforces strict permissions for homeowners, contractors, and administrators across the entire application stack.</li>
<li><strong>Integrated Payments &amp; Vetting:</strong> A seamless contractor onboarding and payment system is built using Stripe Connect and Stripe Checkout, automated via secure webhooks.</li>
<li><strong>Automated CI/CD:</strong> A complete DevOps pipeline using GitHub Actions and Google Cloud's Workload Identity Federation enables secure, automated deployments to isolated development, staging, and production environments.</li>
</ul>
<p>This plan provides a blueprint for building a high-performance, secure, and scalable platform poised to capture a significant share of the growing AIP market.</p>
<hr>
<h3 id="1-high-level-system-architecture-2"><strong>1. High-Level System Architecture</strong></h3>
<p>HOMEase AI employs a serverless, event-driven architecture hosted entirely on GCP. This model is chosen for its inherent scalability, pay-per-use cost structure, and reduced operational overhead.</p>
<h4 id="11-core-technology-stack-2"><strong>1.1. Core Technology Stack</strong></h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication with NextAuth.js v5</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd Gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (Analysis), <a href="http://Fal.ai">Fal.ai</a> (Visualization)</li>
<li><strong>Payments:</strong> Stripe (Connect &amp; Checkout)</li>
<li><strong>CI/CD:</strong> GitHub Actions &amp; Google Cloud Build</li>
</ul>
<h4 id="12-architecture-diagram-2"><strong>1.2. Architecture Diagram</strong></h4>
<p>The diagram below illustrates the interaction between system components. The Next.js application on Cloud Run serves as the primary interface, orchestrating calls to backend services and responding to real-time database updates.</p>
<pre><code class="language-mermaid">graph TD
    subgraph &quot;User Devices&quot;
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph &quot;Google Cloud Platform&quot;
        subgraph &quot;Application &amp; API Tier&quot;
            C(Next.js App on Cloud Run)
        end

        subgraph &quot;Asynchronous Processing Tier&quot;
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
            P[Cloud Function: stripeWebhookHandler]
        end

        subgraph &quot;Data &amp; Persistence Tier&quot;
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph &quot;External Services&quot;
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions &amp; Synchronous Flow
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C
    C -- Authenticates User --&gt; H
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J
    C -- Initiates Onboarding/Payment --&gt; L

    %% Asynchronous Workflows
    C -- Publishes Message --&gt; D
    C -- Publishes Message --&gt; E
    D -- Triggers --&gt; F
    E -- Triggers --&gt; G
    L -- Sends Webhooks --&gt; P

    %% Backend Processing
    F -- Reads/Writes Data --&gt; I
    G -- Reads Files --&gt; J
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Results --&gt; I
    P -- Writes Payment/Vetting Status --&gt; I

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</code></pre>
<hr>
<h3 id="2-data-modeling--persistence-1"><strong>2. Data Modeling &amp; Persistence</strong></h3>
<p>The data layer is built on Firestore, a scalable NoSQL database. The schema is designed with denormalization to optimize for the application's primary read patterns.</p>
<h4 id="21-firestore-collection-schema-1"><strong>2.1. Firestore Collection Schema</strong></h4>
<ul>
<li><strong><code>users</code></strong>: Stores profiles for all roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>), identified by their Firebase Auth UID. Contractor profiles include a <code>contractorProfile</code> map containing vetting status, specialties, service area ZIPs, and their <code>stripeAccountId</code>.</li>
<li><strong><code>leads</code></strong>: Represents a homeowner's request for work. It includes denormalized homeowner info, the <code>arAssessmentId</code>, status (<code>new</code>, <code>matching</code>, <code>matched</code>, <code>sold</code>), price, and arrays for <code>matchedContractorIds</code> and <code>purchasedBy</code> contractor IDs.</li>
<li><strong><code>ar-assessments</code></strong>: Contains the results of an AR scan, including <code>status</code> (<code>processing</code>, <code>complete</code>), links to raw data in Cloud Storage, and the final <code>results</code> from the Gemini AI analysis.</li>
<li><strong><code>projects</code></strong>: Tracks a confirmed job between a homeowner and contractor, linking the lead, participants, and final scope.</li>
<li><strong><code>chats</code></strong>: Manages conversation threads, with a <code>messages</code> subcollection for individual messages.</li>
<li><strong><code>reviews</code></strong>: Stores ratings and comments for completed projects. An <code>onWrite</code> Cloud Function aggregates these reviews to update a contractor's average rating in their <code>users</code> document.</li>
<li><strong><code>transactions</code></strong>: Logs all payment events from Stripe for accounting and auditing, using the Stripe session or payment intent ID as the document ID for idempotency.</li>
</ul>
<h4 id="22-firestore-security-rules-1"><strong>2.2. Firestore Security Rules</strong></h4>
<p>Security rules are the primary mechanism for enforcing data access control at the database level. They are non-negotiable and protect data even if the application backend is compromised.</p>
<ul>
<li><strong>Users</strong>: Users can read and update their own profiles. Public contractor information is readable by any authenticated user. Admins have full access.</li>
<li><strong>Leads</strong>: A lead can be read only by its owner, a matched contractor, or an admin. Only homeowners can create leads.</li>
<li><strong>AR Assessments</strong>: Can only be accessed by the user who created it or an admin.</li>
<li><strong>Chats &amp; Messages</strong>: Can only be accessed by the participants of the chat.</li>
<li><strong>Reviews</strong>: Are public to read but can only be created by the homeowner of a completed project. Reviews are immutable by users.</li>
</ul>
<hr>
<h3 id="3-authentication--role-based-access-control-rbac-1"><strong>3. Authentication &amp; Role-Based Access Control (RBAC)</strong></h3>
<p>A multi-layered RBAC strategy ensures that users can only perform actions and access data appropriate for their role.</p>
<ol>
<li><strong>Authentication Provider</strong>: <strong>NextAuth.js v5</strong> is used with the <strong>Firebase Auth provider</strong>. Firebase securely manages user credentials, social logins, and issues ID tokens.</li>
<li><strong>Authoritative Role Source</strong>: <strong>Firebase Custom Claims</strong> are the single source of truth for user roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>).</li>
<li><strong>Role Assignment</strong>: Upon user signup, a Cloud Function (<code>onUserCreate</code>) is triggered. It reads the user's intended role (set during the signup flow) from a temporary Firestore document and uses the Firebase Admin SDK to write the role as a custom claim to the user's auth token. This process is entirely server-side and secure from client-side manipulation.</li>
<li><strong>Session Propagation</strong>: NextAuth.js is configured to decode the user's ID token upon login, extract the custom <code>role</code> claim, and inject it into the session object.</li>
<li><strong>Permission Enforcement</strong>:
<ul>
<li><strong>Next.js (Server Components &amp; API Routes)</strong>: Server-side code checks <code>session.user.role</code> to authorize access to pages and API endpoints.</li>
<li><strong>Next.js (Client Components)</strong>: The UI is conditionally rendered based on the <code>role</code> available in the <code>useSession()</code> hook.</li>
<li><strong>Cloud Functions</strong>: Callable Functions automatically receive a verified auth <code>context</code> containing the decoded token and its claims, allowing for role checks at the start of any backend process.</li>
<li><strong>Firestore Rules</strong>: Rules use helper functions to read the user's role from their request token (<code>request.auth.token.role</code>) to enforce database-level permissions.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-core-workflows-1"><strong>4. Core Workflows</strong></h3>
<p>The platform's primary functions are designed as decoupled, asynchronous workflows to ensure scalability and a responsive user experience.</p>
<h4 id="41-ar-assessment--ai-processing-1"><strong>4.1. AR Assessment &amp; AI Processing</strong></h4>
<ol>
<li><strong>Upload</strong>: The homeowner's app uploads raw AR data (images, measurements) directly to a secure path in <strong>Google Cloud Storage</strong>.</li>
<li><strong>Trigger</strong>: Upon successful upload, the app calls a lightweight Next.js API route (<code>/api/ar-assessments/process</code>), which updates the assessment's status in Firestore to <code>'processing'</code> and publishes a message to the <code>ar-assessment-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Process</strong>: An event-driven <strong>Cloud Function (<code>arProcessing</code>)</strong> is triggered by the Pub/Sub message. It downloads the data from Storage, sends it to the <strong>Google Gemini API</strong> for hazard detection and recommendations, and calls <strong><a href="http://Fal.ai">Fal.ai</a></strong> to generate &quot;after&quot; visualizations.</li>
<li><strong>Update</strong>: The function writes the complete analysis back to the assessment's Firestore document and updates its status to <code>'complete'</code>.</li>
<li><strong>Notify</strong>: The homeowner's app, listening for real-time changes to the document, automatically updates the UI to display the full report.</li>
</ol>
<h4 id="42-lead-generation--contractor-matching-1"><strong>4.2. Lead Generation &amp; Contractor Matching</strong></h4>
<ol>
<li><strong>Submission</strong>: A homeowner submits a lead request via a Next.js form. The API route (<code>/api/leads/create</code>) validates the data, creates a new lead document in Firestore with a status of <code>'new'</code>, and immediately publishes a message with the <code>leadId</code> to the <code>lead-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Matching</strong>: The <code>leadMatching</code> <strong>Cloud Function</strong> is triggered. It updates the lead status to <code>'matching'</code>, then queries the <code>users</code> collection for approved contractors whose <code>serviceAreaZips</code> and <code>specialties</code> match the lead's requirements.</li>
<li><strong>Ranking &amp; Update</strong>: The function ranks the potential matches (e.g., by average rating, review count) and updates the lead document in Firestore with an array of the top <code>matchedContractorIds</code> and a new status of <code>'matched'</code>.</li>
<li><strong>Notify</strong>: Both the homeowner and the matched contractors receive real-time updates in their dashboards via Firestore listeners, informing them of the match.</li>
</ol>
<h4 id="43-contractor-onboarding--payments-1"><strong>4.3. Contractor Onboarding &amp; Payments</strong></h4>
<ol>
<li><strong>Onboarding</strong>: The system uses <strong>Stripe Connect Express</strong>. A contractor initiates onboarding from their dashboard, triggering a server-side process that creates a Stripe Express account and generates a one-time onboarding link. The contractor is redirected to Stripe's co-branded UI to submit their business and bank details.</li>
<li><strong>Verification</strong>: Stripe handles the identity verification asynchronously. When the account is verified, Stripe sends an <code>account.updated</code> event to a secure webhook endpoint.</li>
<li><strong>Pay-Per-Lead Purchase</strong>: An approved contractor can purchase a lead. This action calls a Next.js API route that creates a <strong>Stripe Checkout Session</strong>, embedding the <code>leadId</code> and <code>contractorId</code> in the session's <code>metadata</code>. The contractor is redirected to Stripe's secure payment page.</li>
<li><strong>Webhook Handling</strong>: A single, secure <strong>Cloud Function (<code>stripeWebhookHandler</code>)</strong> with an HTTP trigger acts as the endpoint for all Stripe webhooks. It verifies the Stripe signature of every incoming request.
<ul>
<li>On an <code>account.updated</code> event, it updates the contractor's <code>vettingStatus</code> in Firestore to <code>'approved'</code>.</li>
<li>On a <code>checkout.session.completed</code> event, it reads the <code>metadata</code> to identify the lead and contractor, then updates the lead document in Firestore to grant the contractor access.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-frontend-architecture-nextjs-15-on-cloud-run-1"><strong>5. Frontend Architecture (Next.js 15 on Cloud Run)</strong></h3>
<p>The frontend is a monolithic Next.js 15 application using the App Router, prioritizing performance and maintainability with a &quot;Server-First&quot; approach.</p>
<ul>
<li><strong>Component Strategy</strong>: <strong>React Server Components (RSCs)</strong> are used by default to fetch data and render UI on the server, minimizing client-side JavaScript. <strong>Client Components (<code>'use client'</code>)</strong> are used only when necessary for interactivity, such as forms, AR uploaders, and real-time chat windows.</li>
<li><strong>Directory Structure</strong>: A feature-based directory structure (<code>/src/app/(dashboard)/contractor</code>, <code>/src/components/features/leads</code>) keeps the codebase organized.</li>
<li><strong>Styling</strong>: <strong>Tailwind CSS</strong> with <strong>Shadcn/UI</strong> provides a modern, utility-first design system.</li>
<li><strong>Deployment Container</strong>: The application is containerized using a multi-stage <code>Dockerfile</code> that builds the app and copies the optimized standalone output into a lean <code>node:20-alpine</code> image. This creates a small, secure image ideal for Cloud Run.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-cicd-1"><strong>6. Deployment &amp; DevOps (CI/CD)</strong></h3>
<p>A fully automated CI/CD pipeline using GitHub Actions ensures reliable and frequent deployments to GCP.</p>
<ul>
<li><strong>Environments</strong>: Three isolated GCP projects (<code>homease-ai-dev</code>, <code>-staging</code>, <code>-prod</code>) provide complete separation for Development, Staging, and Production environments.</li>
<li><strong>Branching Strategy</strong>: A GitFlow model is used. Merges to <code>develop</code>, <code>staging</code>, and <code>main</code> branches trigger deployments to their corresponding environments.</li>
<li><strong>Secure Authentication</strong>: <strong>Workload Identity Federation (WIF)</strong> provides a secure, keyless mechanism for GitHub Actions to authenticate with GCP. This eliminates the need to store long-lived service account keys as GitHub secrets.</li>
<li><strong>Workflows</strong>:
<ol>
<li><strong>PR Validation</strong>: On every pull request to <code>develop</code>, a workflow runs linting, type-checking, and tests to maintain code quality.</li>
<li><strong>Frontend Deployment</strong>: On pushes to key branches, a workflow builds the Next.js Docker image, pushes it to <strong>Google Artifact Registry</strong>, and deploys it as a new revision to <strong>Google Cloud Run</strong>. Secrets are securely injected from <strong>Google Secret Manager</strong>.</li>
<li><strong>Backend Deployment</strong>: A separate workflow, triggered by changes in the <code>/functions</code> directory or rules files, uses the Firebase CLI to deploy Cloud Functions, Firestore rules, and Storage rules to the appropriate GCP project.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="7-security-compliance-and-vetting-2"><strong>7. Security, Compliance, and Vetting</strong></h3>
<p>Security is a foundational principle, integrated at every layer of the platform.</p>
<ul>
<li><strong>Application Security</strong>:
<ul>
<li><strong>Content Security Policy (CSP)</strong>: A strict CSP is enforced via Next.js middleware to prevent XSS attacks.</li>
<li><strong>Input Validation</strong>: <strong>Zod</strong> is used to validate all incoming data on every API endpoint and Cloud Function, preventing injection attacks and ensuring data integrity.</li>
<li><strong>Secure Headers</strong>: Standard security headers (HSTS, X-Content-Type-Options) are configured.</li>
</ul>
</li>
<li><strong>Compliance</strong>:
<ul>
<li><strong>CCPA</strong>: The platform provides users with the right to know, delete, and opt-out of data sales (which HOMEase does not do).</li>
<li><strong>'HIPAA-lite'</strong>: While not a covered entity, HOMEase AI treats home accessibility data as sensitive. We practice <strong>data minimization</strong> (collecting only functional needs, not medical diagnoses) and enforce strict access controls.</li>
<li><strong>Encryption</strong>: All data is encrypted in transit (TLS 1.3) and at rest (Google-managed AES-256).</li>
</ul>
</li>
<li><strong>Contractor Vetting</strong>: A multi-stage process ensures contractor quality.
<ol>
<li><strong>Submission</strong>: Contractors upload licenses and proof of insurance to a secure Cloud Storage bucket.</li>
<li><strong>Verification</strong>: An internal admin team verifies these documents and initiates a third-party background check (e.g., via Checkr).</li>
<li><strong>Status Management</strong>: The contractor's <code>vettingStatus</code> (<code>pending</code>, <code>approved</code>, <code>rejected</code>) is managed in their Firestore document via an admin-only dashboard. Only <code>'approved'</code> contractors are eligible for lead matching.</li>
<li><strong>Secure Storage</strong>: Firebase Storage rules ensure that vetting documents can only be uploaded by the contractor and read by authorized administrators.</li>
</ol>
</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;subtask_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span>
<span class="hljs-punctuation">}</span>
</code></pre>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>